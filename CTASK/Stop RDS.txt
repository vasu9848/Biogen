1. Get Ticket

Pre Execution:

Process.RunbookName = Process.InstanceName
Process.RunbookID = Process.RuntimeROID
var uri="https://"+Process.Instance+".service-now.com/api/now/table/task?sysparm_fields=number%2Cactive%2Csys_id%2Cincident_state%2Cdescription%2Cu_document_results%2Cassigned_to=SVC-itpam@biogen.com&sysparm_limit=1&number="+Process.CTASK_Number
Process.url=uri

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket details fetched successfully."
   Process.Output=Process[OpName].HTTPResponseContent
} 
else if(Process[OpName].Reason.indexOf('non-success') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent  
}
else if(Process[OpName].Reason.indexOf('failure') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent

}
else
{
  	Process.ReturnCode=2;
  	Process.ReturnMessage="Failure fetching ticket details."

}


2.Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('incident_state')>=0)
  {Process.Incidentstate=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('u_document_results')>=0)
  {Process.document_results=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active)
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Script

Inline:

Param(
[String]$Sys_id,
[String]$Instance
)
$sys_id = $Sys_id

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls, [Net.SecurityProtocolType]::Tls11, [Net.SecurityProtocolType]::Tls12, [Net.SecurityProtocolType]::Ssl3
[Net.ServicePointManager]::SecurityProtocol = "Tls, Tls11, Tls12, Ssl3"
$SNOWPassword="V2!RfaRE#%4GQ*J_"
$password = ConvertTo-SecureString $SNOWPassword -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential ("svc_itpam", $password)

$actual_start_date = Get-Date

$update_ctask_work_start_uri = "https://$Instance.service-now.com/api/now/table/change_task/$sys_id"

$Body1 = @{
    "work_start"="$actual_start_date"
}

$BodyJson1 = $Body1 | ConvertTo-Json
try {
 Invoke-WebRequest -Uri $update_ctask_work_start_uri -Body $BodyJson1 -Credential $Cred -Method "PUT" -ContentType "application/json" -UseBasicParsing -ErrorAction stop
 Write-host "Actual Start Date updated successfully"
} catch {
	Write-host $_.
	Write-host "Update Actual Start Date Service NOW API failed"
}

Post Execution:

if(Process[OpName].scriptOutput.indexOf('successfully') >= 0)
{

  Process.ReturnCode = 0
  Process.ReturnMessage = "CTASK actual start date updated successfully."

}

else if(Process[OpName].scriptOutput.indexOf('failed') >= 0)
{
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to update actual start date CTASK."

}
else 
{
	Process.ReturnCode = 2
	Process.ReturnMessage = "Some error occurred while updating CTASK work in progress state in Service Now."
	
}

4.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.Instance+".service-now.com/api/now/v2/table/change_task/"+Process.Sys_Id
Process.updateWorkNotes = "<request><entry><state>2</state><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+" </work_notes></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket worknotes updated successfully."

}
else if(Process[OpName].Reason.indexOf('non-success') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else if(Process[OpName].Reason.indexOf('failure') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else
{
    Process.ReturnCode=2;
    Process.ReturnMessage="Failure updating ticket details."

}

5.Script

Inline:

Param($account_name)

$aws_auth = Get-Content "//usawsgabb0082\Linux_Prod\KION.txt"

'kion'

<#if($aws_auth -contains $account_name)
{
'kion'
}
else
{
'turbot'
}#>

Post Execution:

if(Process[OpName].scriptOutput.indexOf('kion') >= 0)
{
	Process.auth_name = Process[OpName].scriptOutput
	Process.ReturnCode = 1
}
else if(Process[OpName].scriptOutput.indexOf('turbot') >= 0)
{
  Process.auth_name = Process[OpName].scriptOutput
  Process.ReturnCode = 1
}
else 
{
	Process.ReturnCode = 2
	Process.ReturnMessage = "Unable to identify the account name is under Turbot or KION."
}

6.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_id="+Process.account_name+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_name="+Process.account_name+" role="+Process.role+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].mainout.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].mainout.indexOf('failed=0') >= 0){
Process.ReturnCode = 0
Process.ReturnMessage =  "RDS Instance Stopped successfully."
//Process.ReturnCode = 2
//Process.ReturnMessage =  "Failed to Stop the RDS instance."
}

else if(Process[OpName].mainout.indexOf('RDS Instance is already stopped') >= 0){
  Process.ReturnCode = 4
  Process.ReturnMessage = "RDS Instance is already in Stopped state."

}
else if(Process[OpName].mainout.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}

else if(Process[OpName].mainout.indexOf('Unable to fetch RDS status') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to fetch RDS status."

}

else if(Process[OpName].mainout.indexOf('Pre Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Post Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Post Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Script execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Mounting Script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf("'skipping: [localhost] => (item={u'Code': 16, u'Name': u'running'})'") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Skipping Server is already in running state."

}

else if(Process[OpName].mainout.indexOf('Pre check report fetch failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre check report fetch failed."

}
else if(Process[OpName].mainout.indexOf("the field 'args' has an invalid value") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error occured while executing playbook."

}
else if(Process[OpName].mainout.indexOf(Process.ins+" does not exist") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage =Process.ins +" does not exist."

}
else if(Process[OpName].mainout.indexOf('Fetch Post Check HTML Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Fetch Post Check HTML Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Pre Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Pre Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Post Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Post Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].mainout.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}
else if(Process[OpName].mainout.indexOf('Failed to Start the RDS Instance') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to Stop the RDS Instance."

}



else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


7.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_id="+Process.account_name+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_name="+Process.account_name+" role="+Process.role+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].mainout.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].mainout.indexOf('failed=0') >= 0){
Process.ReturnCode = 0
Process.ReturnMessage =  "RDS Instance Stopped successfully."
//Process.ReturnCode = 2
//Process.ReturnMessage =  "Failed to Start the RDS instance."
}

else if(Process[OpName].mainout.indexOf('RDS Instance is already stopped') >= 0){
  Process.ReturnCode = 4
  Process.ReturnMessage = "RDS Instance is already in Stopped state."

}
else if(Process[OpName].mainout.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}

else if(Process[OpName].mainout.indexOf('Unable to fetch RDS status') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to fetch RDS status."

}

else if(Process[OpName].mainout.indexOf('Pre Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Post Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Post Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Script execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Mounting Script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf("'skipping: [localhost] => (item={u'Code': 16, u'Name': u'running'})'") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Skipping Server is already in running state."

}

else if(Process[OpName].mainout.indexOf('Pre check report fetch failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre check report fetch failed."

}
else if(Process[OpName].mainout.indexOf("the field 'args' has an invalid value") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error occured while executing playbook."

}
else if(Process[OpName].mainout.indexOf(Process.ins+" does not exist") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage =Process.ins +" does not exist."

}
else if(Process[OpName].mainout.indexOf('Fetch Post Check HTML Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Fetch Post Check HTML Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Pre Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Pre Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Post Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Post Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].mainout.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}
else if(Process[OpName].mainout.indexOf('Failed to Start the RDS Instance') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to Stop the RDS Instance."

}



else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


8.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_id="+Process.account_name+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_name="+Process.account_name+" role="+Process.role+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].mainout.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].mainout.indexOf('failed=0') >= 0){
Process.ReturnCode = 0
Process.ReturnMessage =  "RDS Instance Stopped successfully."
//Process.ReturnCode = 2
//Process.ReturnMessage =  "Failed to Start the RDS instance."
}

else if(Process[OpName].mainout.indexOf('RDS Instance is already stopped') >= 0){
  Process.ReturnCode = 4
  Process.ReturnMessage = "RDS Instance is already in Stopped state."

}
else if(Process[OpName].mainout.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}

else if(Process[OpName].mainout.indexOf('Unable to fetch RDS status') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to fetch RDS status."

}

else if(Process[OpName].mainout.indexOf('Pre Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Post Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Post Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Script execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Mounting Script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf("'skipping: [localhost] => (item={u'Code': 16, u'Name': u'running'})'") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Skipping Server is already in running state."

}

else if(Process[OpName].mainout.indexOf('Pre check report fetch failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre check report fetch failed."

}
else if(Process[OpName].mainout.indexOf("the field 'args' has an invalid value") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error occured while executing playbook."

}
else if(Process[OpName].mainout.indexOf(Process.ins+" does not exist") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage =Process.ins +" does not exist."

}
else if(Process[OpName].mainout.indexOf('Fetch Post Check HTML Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Fetch Post Check HTML Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Pre Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Pre Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Post Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Post Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].mainout.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}
else if(Process[OpName].mainout.indexOf('Failed to Start the RDS Instance') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to Stop the RDS Instance."

}



else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


9.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_id="+Process.account_name+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/pre.yml -e 'acc_name="+Process.account_name+" role="+Process.role+" az="+Process.available_zone+" env="+Process.env+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].mainout.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].mainout.indexOf('failed=0') >= 0){
Process.ReturnCode = 0
Process.ReturnMessage =  "RDS Instance Stopped successfully."
//Process.ReturnCode = 2
//Process.ReturnMessage =  "Failed to Start the RDS instance."
}

else if(Process[OpName].mainout.indexOf('RDS Instance is already stopped') >= 0){
  Process.ReturnCode = 4
  Process.ReturnMessage = "RDS Instance is already in Stopped state."

}
else if(Process[OpName].mainout.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}

else if(Process[OpName].mainout.indexOf('Unable to fetch RDS status') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to fetch RDS status."

}

else if(Process[OpName].mainout.indexOf('Pre Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Post Check Report execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Post Check Execution script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf('Script execution failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Mounting Script Failed to Execute."

}
else if(Process[OpName].mainout.indexOf("'skipping: [localhost] => (item={u'Code': 16, u'Name': u'running'})'") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Skipping Server is already in running state."

}

else if(Process[OpName].mainout.indexOf('Pre check report fetch failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Pre check report fetch failed."

}
else if(Process[OpName].mainout.indexOf("the field 'args' has an invalid value") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error occured while executing playbook."

}
else if(Process[OpName].mainout.indexOf(Process.ins+" does not exist") >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage =Process.ins +" does not exist."

}
else if(Process[OpName].mainout.indexOf('Fetch Post Check HTML Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Fetch Post Check HTML Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Pre Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Pre Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('Generating Post Check PDF Report Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating Post Check PDF Report Failed."

}
else if(Process[OpName].mainout.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].mainout.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}
else if(Process[OpName].mainout.indexOf('Failed to Start the RDS Instance') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to Stop the RDS Instance."

}



else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


If ReturnCode is 4

10.Script

Inline:

Param(
[String]$Sys_id,
[String]$Instance
)
$sys_id = $Sys_id

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls, [Net.SecurityProtocolType]::Tls11, [Net.SecurityProtocolType]::Tls12, [Net.SecurityProtocolType]::Ssl3
[Net.ServicePointManager]::SecurityProtocol = "Tls, Tls11, Tls12, Ssl3"
$SNOWPassword="V2!RfaRE#%4GQ*J_"
$password = ConvertTo-SecureString $SNOWPassword -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential ("svc_itpam", $password)

$actual_start_date = Get-Date

$update_ctask_work_start_uri = "https://$Instance.service-now.com/api/now/table/change_task/$sys_id"

$Body1 = @{
    "work_end"="$actual_start_date"
}

$BodyJson1 = $Body1 | ConvertTo-Json
try {
 Invoke-WebRequest -Uri $update_ctask_work_start_uri -Body $BodyJson1 -Credential $Cred -Method "PUT" -ContentType "application/json" -UseBasicParsing -ErrorAction stop
 Write-host "Actual Start Date updated successfully"
} catch {
	Write-host $_.
	Write-host "Update Actual Start Date Service NOW API failed"
}


Post Execution:

if(Process[OpName].scriptOutput.indexOf('successfully') >= 0)
{

  Process.ReturnCode = 0
  Process.ReturnMessage = "CTASK actual end date updated successfully."

}

else if(Process[OpName].scriptOutput.indexOf('failed') >= 0)
{
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to update actual end date CTASK."

}
else 
{
	Process.ReturnCode = 2
	Process.ReturnMessage = "Some error occurred while updating CTASK work in progress state in Service Now."

}

11.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.Instance+".service-now.com/api/now/v2/table/change_task/"+Process.Sys_Id
Process.update = "<request><entry><u_close_code>unsuccessful - cancelled</u_close_code><u_document_results>Instance is already in stopped state</u_document_results><close_notes>RDS Instance is already in Stopped state</close_notes><work_notes>Instance is already in stopped state.</work_notes><state>3</state></entry></request>"
//Process.update_status ="<request><entry><u_document_results>EC2 Start completed</u_document_results><u_close_code>successful</u_close_code><close_notes>EC2 start executed successfully</close_notes><work_notes>.</work_notes><state>3</state></entry></request>"


12.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.Instance+".service-now.com/api/now/v2/table/change_task/"+Process.Sys_Id
Process.updateWorkNotes = "<request><entry><state>2</state><work_notes>"+ Process.ReturnMessage+" </work_notes></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket worknotes updated successfully."

}
else if(Process[OpName].Reason.indexOf('non-success') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else if(Process[OpName].Reason.indexOf('failure') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else
{
    Process.ReturnCode=2;
    Process.ReturnMessage="Failure updating ticket details."

}

13.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" acc_id="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" role="+Process.role+" acc_name="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].output.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].output.indexOf('Permission denied') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to decrypt Vault file."

}
else if(Process[OpName].output.indexOf('Stopping Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to stop the RDS Instance"

}
else if(Process[OpName].output.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}
else if(Process[OpName].output.indexOf('fatal:  [') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "error occurred while executing the Ansible Playbook."

} 

else if(Process[OpName].output.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].output.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}

else if(Process[OpName].output.indexOf('The offending line appears to be:') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error in playbook."

}
else if(Process[OpName].output.indexOf('failed=0') >= 0){
  Process.ReturnCode = 0
  Process.ReturnMessage = "Playbook Execution Successfull."

}else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}

14.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" acc_id="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" role="+Process.role+" acc_name="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].output.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].output.indexOf('Permission denied') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to decrypt Vault file."

}
else if(Process[OpName].output.indexOf('Stopping Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to stop the RDS Instance"

}
else if(Process[OpName].output.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}
else if(Process[OpName].output.indexOf('fatal:  [') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "error occurred while executing the Ansible Playbook."

} 

else if(Process[OpName].output.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].output.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}

else if(Process[OpName].output.indexOf('The offending line appears to be:') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error in playbook."

}
else if(Process[OpName].output.indexOf('failed=0') >= 0){
  Process.ReturnCode = 0
  Process.ReturnMessage = "Playbook Execution Successfull."

}else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


15.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" acc_id="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" role="+Process.role+" acc_name="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].output.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].output.indexOf('Permission denied') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to decrypt Vault file."

}
else if(Process[OpName].output.indexOf('Stopping Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to stop the RDS Instance"

}
else if(Process[OpName].output.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}
else if(Process[OpName].output.indexOf('fatal:  [') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "error occurred while executing the Ansible Playbook."

} 

else if(Process[OpName].output.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].output.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}

else if(Process[OpName].output.indexOf('The offending line appears to be:') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error in playbook."

}
else if(Process[OpName].output.indexOf('failed=0') >= 0){
  Process.ReturnCode = 0
  Process.ReturnMessage = "Playbook Execution Successfull."

}else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


16.Linux Operator

Pre Execution:

if(Process.auth_name.indexOf('turbot') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" acc_id="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.130.126"
}
else if(Process.auth_name.indexOf('kion') >= 0){
Process.ansibleCommand = "ansible-playbook ~/prod_rds_stop/post.yml -e 'env="+Process.env+" role="+Process.role+" acc_name="+Process.account_name+" az="+Process.available_zone+" cn="+Process.CTASK_Number+" an="+Process.account_name+" ins="+Process.ins+"'"
Process.ansible_hostname = "10.240.151.74"
}
else
{
Process.ReturnCode = -1
}

Post Execution:

if(Process[OpName].output.indexOf('Failed to connect to the host via ssh') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to connect to the host via ssh."

}
else if(Process[OpName].output.indexOf('Permission denied') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Unable to decrypt Vault file."

}
else if(Process[OpName].output.indexOf('Stopping Failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to stop the RDS Instance"

}
else if(Process[OpName].output.indexOf('File copy failed') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Copying file to Remote Server Failed."

}
else if(Process[OpName].output.indexOf('fatal:  [') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "error occurred while executing the Ansible Playbook."

} 

else if(Process[OpName].output.indexOf('file not found') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "file not found."

}
else if(Process[OpName].output.indexOf('Error: Failed to load') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Generating PDF Failed."

}

else if(Process[OpName].output.indexOf('The offending line appears to be:') >= 0){
  Process.ReturnCode = 2
  Process.ReturnMessage = "Error in playbook."

}
else if(Process[OpName].output.indexOf('failed=0') >= 0){
  Process.ReturnCode = 0
  Process.ReturnMessage = "Playbook Execution Successfull."

}else
{
	Process.ReturnCode = 3
	Process.ReturnMessage = "Some error occurred while executing the Ansible Playbook."

}


17.Script

Inline:

Param(
[String]$CTASK_Number
)
#$Linux_path = "\\usawsgabb0160\Linux_Val\RDS_Stop\$($CTASK_Number)\*.pdf"
$Linux_path = "\\usawsgabb0082\Linux_Prod\RDS_Stop\$($CTASK_Number)\*.pdf"
#$Linux_path = "\\usawsgaax0061\Linux_qualify\RDS_Stop\$($CTASK_Number)\*.pdf"

$dest = "D:\RDS_Stop\$($CTASK_Number)"


if(!(Test-Path -path $dest)){
New-Item -Path $dest -ItemType directory | out-null
}
try {
Copy-Item $Linux_path $dest -ErrorAction stop
} Catch {
Write-host "File copy failed"
}try
{
$file=Get-ChildItem -Force -Recurse -File -Path "$dest" -ErrorAction stop
$name=$file.Name
if($name -like "*pre*"){
write-host "PDF exist"
$prefullPath = $($file.FullName -like "*pre*")
$prefileName = $($file.Name -like "*pre*")
$prefullPath
$prefileName
}else {
write-host "Pre Check PDF Report not found"
}
}
catch
{
Write-Host "Some Error Occured while uploading pre and post check pdf report"
}

Post Execution:

if(Process[OpName].scriptOutput.indexOf("PDF exist")>=0)
{
Process.ReturnCode = 0
Process.ReturnMessage = "PDF Generated successfully"
Process.Data = Process[OpName].scriptOutput
}
else if(Process[OpName].scriptOutput.indexOf("Pre Check PDF Report not found")>=0)
{
Process.ReturnCode = 2
Process.ReturnMessage = "Pre Check PDF Report not found."

}
else
{
Process.ReturnCode=2
Process.ReturnMessage = "Error occurred while executing the verification script."
}



18.Ticket Update

Pre Execution:

Process.dat=Process.file_pre.scriptOutput.split('\n')
Process.fname=Process.dat[2]
Process.pdffile=Process.dat[1]

//Process.putURL= "https://"+Process.Instance+".service-now.com/api/now/attachment/file?table_name=change_task&table_sys_id="+Process.Sys_Id+"&file_name="+Process.fname


Process.putURL= "https://"+Process.Instance+".service-now.com/api/now/attachment/file?table_name=change_task&table_sys_id="+Process.Sys_Id+"&file_name="+Process.fname
//Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"


Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="Created" && Process[OpName].HTTPResponseStatusCode==201 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="PDF updated successfully"
  

}
else if(Process[OpName].Reason.indexOf('non-success') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent

}
else if(Process[OpName].Reason.indexOf('failure') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Error occurred while uploading PDF file to Service Now. "
  
}

19.Script

Inline:

Param([String]$CTASK_Number)
#$Linux_path = "\\usawsgabb0160\Linux_Val\RDS_Stop\$($CTASK_Number)\*.pdf"
$Linux_path = "\\usawsgabb0082\Linux_Prod\RDS_Stop\$($CTASK_Number)\*.pdf"
#$Linux_path = "\\usawsgaax0061\Linux_qualify\RDS_Stop\$($CTASK_Number)\*.pdf"

$dest = "D:\RDS_Stop\$($CTASK_Number)"



if(!(Test-Path -path $dest)){
New-Item -Path $dest -ItemType directory
}
try {
Copy-Item $Linux_path $dest -ErrorAction stop

} 
Catch {
Write-host "File copy failed"
}
try{
$file=Get-ChildItem -Force -Recurse -File -Path "$dest" -ErrorAction stop
$name=$file.Name
if($name -like "*post*"){
write-host "PDF exist"
$postfullPath = $($file.FullName -like "*post*")
$postfileName = $($file.Name -like "*post*")
$postfullPath
$postfileName
}else {
write-host "Post Check PDF Report not found"
}
}
catch
{
Write-Host "Some Error Occured while uploading pre and post check pdf report"
}

Post Execution:

if(Process[OpName].scriptOutput.indexOf("PDF exist")>=0)
{
Process.ReturnCode = 0
Process.ReturnMessage = "PDF Generated successfully"
Process.Data1 = Process[OpName].scriptOutput
}
else if(Process[OpName].scriptOutput.indexOf("Post Check PDF Report not found")>=0)
{
Process.ReturnCode = 2
Process.ReturnMessage = "Pre Check PDF Report not found."

}
else
{
Process.ReturnCode=2
Process.ReturnMessage = "Error occurred while executing the verification script."
}


20.Ticket Update

Pre Execution:


Process.dat=Process.file_post.scriptOutput.split('\n')
Process.fname=Process.dat[2]
Process.pdffile=Process.dat[1]



Process.putURL= "https://"+Process.Instance+".service-now.com/api/now/attachment/file?table_name=change_task&table_sys_id="+Process.Sys_Id+"&file_name="+Process.fname
//Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="Created" && Process[OpName].HTTPResponseStatusCode==201 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="PDF updated successfully."


}else if(Process[OpName].Reason.indexOf('non-success') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent

}
else if(Process[OpName].Reason.indexOf('failure') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Error occurred while uploading PDF file to Service Now."
  
}

21.Script

Inline:

Param(
[String]$Sys_id,
[String]$Instance
)
$sys_id = $Sys_id

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls, [Net.SecurityProtocolType]::Tls11, [Net.SecurityProtocolType]::Tls12, [Net.SecurityProtocolType]::Ssl3
[Net.ServicePointManager]::SecurityProtocol = "Tls, Tls11, Tls12, Ssl3"
$SNOWPassword="V2!RfaRE#%4GQ*J_"
$password = ConvertTo-SecureString $SNOWPassword -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential ("svc_itpam", $password)

$actual_start_date = Get-Date

$update_ctask_work_start_uri = "https://$Instance.service-now.com/api/now/table/change_task/$sys_id"

$Body1 = @{
    "work_end"="$actual_start_date"
}

$BodyJson1 = $Body1 | ConvertTo-Json
try {
 Invoke-WebRequest -Uri $update_ctask_work_start_uri -Body $BodyJson1 -Credential $Cred -Method "PUT" -ContentType "application/json" -UseBasicParsing -ErrorAction stop
 Write-host "Actual Start Date updated successfully"
} catch {
	Write-host $_.
	Write-host "Update Actual Start Date Service NOW API failed"
}

Post Execution:

if(Process[OpName].scriptOutput.indexOf('successfully') >= 0)
{

  Process.ReturnCode = 0
  Process.ReturnMessage = "CTASK actual end date updated successfully."

}

else if(Process[OpName].scriptOutput.indexOf('failed') >= 0)
{
  Process.ReturnCode = 2
  Process.ReturnMessage = "Failed to update actual end date CTASK."

}
else 
{
	Process.ReturnCode = 2
	Process.ReturnMessage = "Some error occurred while updating CTASK work in progress state in Service Now."

}

22.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.Instance+".service-now.com/api/now/v2/table/change_task/"+Process.Sys_Id
Process.update_status ="<request><entry><u_document_results>RDS Stop completed</u_document_results><u_close_code>successful</u_close_code><close_notes>RDS stopped successfully</close_notes><work_notes>Pre and Post evidence attached to the ticket successfully.</work_notes><state>3</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=1;
  Process.ReturnMessage="Ticket worknotes updated successfully."

}
else if(Process[OpName].Reason.indexOf('non-success') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else if(Process[OpName].Reason.indexOf('failure') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent
}
else
{
    Process.ReturnCode=2;
    Process.ReturnMessage="Failure updating ticket details."

}

23.Fatal Ticket Update

Pre Execution:

Process.putURL="https://"+Process.Instance+".service-now.com/api/now/table/change_task/"+Process.Sys_Id+""
//Process.FatalErrorPayLoad ="<request><entry><assignment_group>d32d41c5dbe73e00d41dd3cb5e96194f</assignment_group><assigned_to></assigned_to><work_start></work_start><work_notes>"+Process.ReturnMessage+"Hence routing the ticket.</work_notes><state>2</state></entry></request>"
Process.assignment_group = "2b8994d1db0caf00fa0f8e5c2996196e"
Process.FatalErrorPayLoad ="<request><entry><u_close_code>Unsuccessful</u_close_code><assignment_group>"+Process.assignment_group+"</assignment_group><assigned_to></assigned_to><work_start></work_start><work_notes>"+Process.ReturnMessage+"Hence routing the ticket.</work_notes><state>1</state></entry></request>"



Ansible Playbooks

prod_rds_stop/pre.yml

---
- hosts: localhost
  gather_facts: false
  #become_method: sudo
  connection: local
  vars:
      share_path: /Linux_Prod/RDS_Stop
  tasks:
    - set_fact:
        aws_account_name: "{{ acc_name }}"
        # aws_account_id: "{{ acc_id }}"
        aws_environment: "{{ env[0] }}"
        role: ia-role
      tags: variables

    - name: Run Kion Stak command to get the access key and secret key
      command: kion --profile nonprod stak --l {{ aws_account_name }} --car {{ role }} -p
      register: non_prod_stak_output
      when: aws_environment != "P"

    - debug:
        msg: "{{ non_prod_stak_output }}"  
      when: aws_environment != "P"   
    
    - name: Run Kion Stak command to get the access key and secret key
      command: kion --profile prod stak --l {{ aws_account_name }} --car {{ role }} -p
      register: prod_stak_output
      when: aws_environment == "P"

    - debug:
        msg: "{{ prod_stak_output }}" 
      when: aws_environment == "P"  

    - name: setting up the variables of non Prod access key and secret key
      set_fact:
        AWS_ACCESS_KEY_ID: "{{ non_prod_stak_output.stdout_lines[0].split('export AWS_ACCESS_KEY_ID=')[1] }}"
        AWS_SECRET_ACCESS_KEY: "{{ non_prod_stak_output.stdout_lines[1].split('export AWS_SECRET_ACCESS_KEY=')[1] }}"
        AWS_SESSION_TOKEN: "{{ non_prod_stak_output.stdout_lines[2].split('export AWS_SESSION_TOKEN=')[1] }}"
      when: aws_environment != "P"

    - name: setting up the variables of Prod access key and secret key
      set_fact:
        AWS_ACCESS_KEY_ID: "{{ prod_stak_output.stdout_lines[0].split('export AWS_ACCESS_KEY_ID=')[1] }}"
        AWS_SECRET_ACCESS_KEY: "{{ prod_stak_output.stdout_lines[1].split('export AWS_SECRET_ACCESS_KEY=')[1] }}"
        AWS_SESSION_TOKEN: "{{ prod_stak_output.stdout_lines[2].split('export AWS_SESSION_TOKEN=')[1] }}"
      when: aws_environment == "P"  

    - name: Configure AWS CLI with Access Key and Secret Key
      shell: |
        aws configure set aws_access_key_id {{ AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key {{ AWS_SECRET_ACCESS_KEY }}
        aws configure set aws_session_token {{ AWS_SESSION_TOKEN }}
        aws configure set region {{ az }}
      register: set_aws_configure  




    - name: Check Current state of the RDS instance
      command: aws rds describe-db-instances --db-instance-identifier {{ ins }} --region {{ az }} --output text --query 'DBInstances[*].DBInstanceStatus'
      register: instance_state
      delegate_to: localhost

    - debug:
        msg: "{{ instance_state }}"
      delegate_to: localhost

    - name: Storing RDS instance status
      set_fact:
        ins_state: "{{ instance_state.stdout }}"
      delegate_to: localhost

    - name: displaying RDS instance status
      debug:
        msg: "{{ instance_state.stdout }}"
      delegate_to: localhost  

    - fail:
        msg: "Unable to fetch RDS status"
      when: instance_state.stdout == "" 

    - debug:
        msg: "RDS Instance is already stopped"
      failed_when: ins_state == "stopped"
      delegate_to: localhost

    - name: Check condition if RDS is already stopped to end playbook
      block:
        - debug:
            msg: "RDS Stopped Successfully"
          when: ins_state != "available"
        - meta: end_play
      when: ins_state != "available"

    - debug:
        msg: "RDS is in available state. Hence Proceeding to stop the RDS"
      when: ins_state == "available"
      delegate_to: localhost       

    - set_fact:
        current_state: Running
      when:  ins_state != "stopped"
      ignore_errors: yes
      # with_items:
      #   - "{{ ins_state }}"
      delegate_to: localhost

    - set_fact:
        current_state: Stopped
      when:  ins_state == "stopped"
      ignore_errors: yes
      # with_items:
      #   - "{{ ins_state }}"
      delegate_to: localhost
    # creating tmp folder with ctask number on remote machine
    - name: creating {{ cn }} directory in tmp folder
      file:
        path: "{{ share_path }}/{{ cn }}"
        state: directory
      become: true
      delegate_to: localhost
      tags: pre_check

    # PRE CHECK REPORT
    - name: Generate the pre check html report
      command: sh /home/svc-linux-snow/prod_rds_stop/pre_check.sh {{ ins }} {{ current_state }} {{ cn }}
      register: pre_check_report
      become: true
      tags: pre_check
    - debug:
        msg: "Pre Check Report executed successfully"
      when: "pre_check_report.rc == 0"
      tags: pre_check
    - debug:
        msg: "Pre Check Report execution failed"
      when: "pre_check_report.rc != 0"
      tags: pre_check

    - name: Stopping the RDS instance
      command: aws rds stop-db-instance --db-instance-identifier {{ ins }} --region {{ az }}
      when:  ins_state != "stopped"
      # with_items:
      #   - "{{ ins_state }}"
      register: stop_ins_status
      ignore_errors: yes
      delegate_to: localhost
        # - include: wait_rds_are_stopped.yml
        #when: chosen_action == "stop"
        # loop: "{{ vars[ 'list_rds_resources_ids1_' + environment ] + vars[ 'list_rds_resources_ids2_' + environment ] }}"
        # loop_control:
        # loop_var: ins

    - name: Wait until the RDS instance status changes to 'stopped'
      command: aws rds describe-db-instances --db-instance-identifier {{ ins }} --region {{ az }} --output text --query 'DBInstances[*].DBInstanceStatus'
      #rds_instance_info:
      #  db_instance_identifier: "{{ins}}"
      register: database_info
      until: "'stopped' in database_info.stdout"
      retries: 45
      delay: 60
      delegate_to: localhost
    
    - debug:
        msg: "{{ database_info }}"
      delegate_to: localhost
    - name: displaying post RDS instance status
      set_fact:
        rds_state: "{{ database_info.stdout }}"
      delegate_to: localhost

    - debug:
        msg: "Instance is still stopped"
      until: rds_state == "stopped" 
      delegate_to: localhost      


    - name: Checking the status of Stopping RDS instance 
      debug:
        msg: "RDS instance Stopped successfully"
      when: stop_ins_status.changed == true
    - name: Checking the status of Stopping RDS instance
      debug:
        msg: "Failed to Stop the RDS instance"
      when: stop_ins_status.changed != true

-----------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/wait_rds_are_stopped.yml

---
- hosts: localhost
  gather_facts: false
  #become_method: sudo
  connection: local
  tasks:
    - name: Wait for RDS stop to finish
      rds_instance_facts:
        db_instance_identifier: "{{ ins }}"
        region: "{{ az }}"
        # command: turbot-aws -a {{ aws_account_id }} rds describe-db-instances --db-instance-identifier {{ ins }} --region {{ az }} --output text --query 'DBInstances[*].DBInstanceStatus'
      register: aws_rds_facts
      until: aws_rds_facts.instances[0].db_instance_status == "stopped"
      retries: 90
      delay: 10
      delegate_to: localhost

------------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/post.yml

---
- hosts: all
  gather_facts: false
  become_method: sudo
  connection: local
  tasks:
    - name: creating {{ cn }} directory in tmp folder
      file:
        path: ~/tickets/RDS_Stop/{{ cn }}
        state: directory
      become: true
      delegate_to: localhost
      tags: file_copy

    - command: cp -r /home/svc-linux-snow/rds_stop/ /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/
      become: true
      register: copy_file

    - debug:
        msg: "Successfully copied"
      when: copy_file.rc == 0

    - debug:
        msg: "Failed to Copy"
      when: copy_file.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/pre.yml
      become: true
      register: change_main

    - debug:
        msg: "Permission provided"
      when: change_main.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/post.yml
      become: true
      register: change_main_1

    - debug:
        msg: "Permission provided"
      when: change_main_1.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main_1.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/post_check.sh
      become: true
      register: change_main_Post

    - debug:
        msg: "Permission provided"
      when: change_main_Post.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main_Post.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/pre_check.sh
      become: true
      register: change_main_Pre

    - debug:
        msg: "Permission provided"
      when: change_main_Pre.rc == 0

    - debug:
        msg: "Failed to Provide Permission"

-----------------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/ansible.cfg

[defaults]
inventory = hosts
host_key_checking = FALSE
warnings = false
deprecation_warnings=False

------------------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/non_prod.yml


---
turbot_access_key_id: ""
turbot_secret_access_key: ""
...

--------------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/pre_check.sh

#!/bin/sh
INS=$1
RDS_INSTANCE_STATE=$2
CTASK_NUMBER=$3
#---create report
(
echo '<HTML><HEAD><TITLE>RDS INSTANCE STATUS</TITLE></HEAD><BODY>'

echo ' <h1><b>
            <center> STOP RDS INSTANCE (Pre Check)</center>
        </b></h1>
    <table width=100% border=1>'
echo ' <tr> <br> </tr>
        <tr>
            <th class="label" colspan=2> Server Baseline Information </th>
        </tr>
        <tr>
            <td><b> DB Name </b></td>
            <td>'$INS'</td>
        </tr>          
        <tr>
            <td><b> Logon ID used for this test </b></td>
            <td>svc-linux-snow</td>
        </tr>   
        <tr>
            <td><b> Report Date and Time </b></td>
            <td>'$(date '+%d%b%Y %H%M |%Z')'</td>
        </tr>
    </table><BR /><BR />'
echo '<table width=100% border=1><TR><TH>DB Instance ID</TH><TH>Current State</TH></TR><tbody>'
echo '<TR><TD ALIGN=CENTER>'$INS'</TD><TD ALIGN=CENTER>'$RDS_INSTANCE_STATE'</TD></TR>'
echo '</tbody></table></body></html>'
) > /Linux_Prod/RDS_Stop/$CTASK_NUMBER/pre_check_report.html
#/tmp/$CTASK_NUMBER/pre_check_report.html

---------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/post_check.sh

#!/bin/sh
INS=$1
INSTANCE_STATE=$2
CTASK_NUMBER=$3

#---create report
(
echo '<HTML><HEAD><TITLE>RDS INSTANCE STATUS</TITLE></HEAD><BODY>'

echo ' <h1><b>
            <center>STOP RDS INSTANCE (Post Check)</center>
        </b></h1>
    <table width=100% border=1>'
echo ' <tr> <br> </tr>
        <tr>
            <th class="label" colspan=2> Server Baseline Information </th>
        </tr>
        <tr>
            <td><b> Host Name </b></td>
            <td>'$INS'</td>
        </tr>          
        <tr>
            <td><b> Logon ID used for this test </b></td>
            <td>svc-linux-snow</td>
        </tr>   
        <tr>
            <td><b> Report Date and Time </b></td>
            <td>'$(date '+%d%b%Y %H%M |%Z')'</td>
        </tr>
    </table><BR /><BR />'
echo '<table width=100% border=1><TR><TH>Instance ID</TH><TH>Current State</TH></TR><tbody>'
echo '<TR><TD ALIGN=CENTER>'$INS'</TD><TD ALIGN=CENTER>'$INSTANCE_STATE'</TD></TR>'
echo '</tbody></table></body></html>'
) > /Linux_Prod/RDS_Stop/$CTASK_NUMBER/post_check_report.html

------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/prod.yml

---
turbot_access_key_id: ""
turbot_secret_access_key: ""
...

--------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/stop_host.yml


---
- hosts: all
  gather_facts: false
  become_method: sudo
  connection: local
  tasks:
    - name: creating {{ cn }} directory in tmp folder
      file:
        path: ~/tickets/RDS_Stop/{{ cn }}
        state: directory
      become: true
      delegate_to: localhost
      tags: file_copy

    - command: cp -r /home/svc-linux-snow/rds_stop/ /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/
      become: true
      register: copy_file

    - debug:
        msg: "Successfully copied"
      when: copy_file.rc == 0

    - debug:
        msg: "Failed to Copy"
      when: copy_file.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/pre.yml
      become: true
      register: change_main

    - debug:
        msg: "Permission provided"
      when: change_main.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/post.yml
      become: true
      register: change_main_1

    - debug:
        msg: "Permission provided"
      when: change_main_1.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main_1.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/post_check.sh
      become: true
      register: change_main_Post

    - debug:
        msg: "Permission provided"
      when: change_main_Post.rc == 0

    - debug:
        msg: "Failed to Provide Permission"
      when: change_main_Post.rc != 0

    - command: sudo chmod 755 /home/svc-linux-snow/tickets/RDS_Stop/{{ cn }}/pre_check.sh
      become: true
      register: change_main_Pre

    - debug:
        msg: "Permission provided"
      when: change_main_Pre.rc == 0

    - debug:
        msg: "Failed to Provide Permission"

----------------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/hosts

localhost hn=usawsaabms0187 az=us-east-1 cn=CTASK0059394 an=abm os_platform= ins=iscdb


-------------------------------------------------------------------------------------------------------------------------------------

prod_rds_stop/vault_key

ebs_linux






