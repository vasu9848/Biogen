1. Get Ticket

Pre Execution:

Process.RunbookName = Process.InstanceName
Process.RunbookID = Process.RuntimeROID
var uri="https://"+Process.Instance+".service-now.com/api/now/table/task?sysparm_fields=number%2Cactive%2Csys_id%2Cincident_state%2Cdescription%2Cu_document_results%2Cassigned_to=SVC-itpam@biogen.com&sysparm_limit=1&number="+Process.CTASK_Number
Process.url=uri

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket details fetched successfully."
   Process.Output=Process[OpName].HTTPResponseContent
} 
else if(Process[OpName].Reason.indexOf('non-success') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent  
}
else if(Process[OpName].Reason.indexOf('failure') >= 0)
{
	Process.ReturnCode =2;
    Process.ReturnMessage = Process[OpName].HTTPResponseContent

}
else
{
  	Process.ReturnCode=2;
  	Process.ReturnMessage="Failure fetching ticket details."

}

2.Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('incident_state')>=0)
  {Process.Incidentstate=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('u_document_results')>=0)
  {Process.document_results=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active)
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Script

Inline:

Param(
$Number,
$snowkey,
$SNOWPassword,
$username,
$password,
$snowp,
$snowpa,
$SNOW_Env,
$RuntimeROID)


$Number
$snowkey
$username
$SNOW_Env
$RuntimeROID

Import-Module "D:\Wave 1 Scripts\Biogen_Module\Biogen_Module.psm1"

Get-SSHTrustedHost | Remove-SSHTrustedHost

$post_evidence = @()
$log = @()
$script_name = "Quota_Space_Expansion"

$path = "D:\Storage\Quota_Expansion\$Number"
$log_path = "$path\Logs"
$Evidence_Path = "$path\Evidence"
$command_path = "$path\Command_Output"
$wkhtmltopdf = "D:\Program Files\wkhtmltopdf\bin\wkhtmltopdf.exe"
$var = "-q"
$pre_html = "$path\Evidence\Pre_check.html"
$pre_pdf = "$path\Evidence\Pre_check.pdf"
$post_html = "$path\Evidence\Post_check.html"
$post_pdf = "$path\Evidence\Post_check.pdf"
$table = "change_task"
$storage_sysID = "6e7f87abdb07d3809d6b58eadc9619ad"

$snowpass = "$snowp"+"#%4"+$snowpa+"_"
$snowpass 

$filePaths = "$path\logs", "$path\Command_Output", "$path\Evidence"
foreach($filePath in $filePaths)
{
    If(!(test-path $filePath))
    {
          New-Item -ItemType Directory -Force -Path $filePath 
    }
}

$log=@()
$log += "-----------------"
$log += "Script Execution Started at $(timestamp)"
$log += "Service Account used for execution is Svc-linux-snow"

try
{
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $global:headers = @{"Authorization" = "Basic "+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($snowkey+":"+$snowpass))}
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $get_inc = "https://$SNOW_Env.service-now.com/api/now/v2/table/change_task?number=$Number"
    $inc_result = Invoke-WebRequest -Uri $get_inc -Headers $global:headers -Method Get -ContentType "application/json" -UseBasicParsing
    $incout = $inc_result | ConvertFrom-JSON
    $inc_sysid = $incout.result.sys_id
    $execution_notes = $incout.result.u_execution_notes
    $inc_sysid = $incout.result.sys_id
    $execution_notes    
    $inc_sysid
    $log += "Sys ID of the Ticket is $inc_sysid"
    $log += "Execution Notes of the Ticket is `n $execution_notes"

    $Cluster_Name = ((($execution_notes -split "Cluster_IP:")[0] -split "ClusterName: ")[1]).Trim()
    $Cluster_IP = ((($execution_notes -split "Directory path:")[0] -split "Cluster_IP: ")[1]).Trim()
    $Directory_Path = ((($execution_notes -split "Additional Size:")[0] -split "Directory path: ")[1]).Trim()
    $req_size = (($execution_notes -split "Additional Size: ")[1]).trim()
}
catch
{
    Write-Host "Failed to fetch Ticket details"
    $log += "Failed to fetch Ticket details"
    End-log -logcontent $log -logpath $log_path
    Exit
}


try
{
	Update-Start -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table
	Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Automation Acknowledged: $RuntimeROID" -table $table
	write-host $Log+= "Updated Start and Automation acknowledged"
	$Log+= "Updated Start and Automation acknowledged"
}
catch
{
	Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to Update start" -table $table
	write-host $Log+= "Unable to Update start"
	$Log+= "Unable to Update start"
	try{Route-ticket -number $number -script_name $script_name  -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Unable to Update start" -table $table}
    catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
    End-log -logcontent $log -logpath $log_path
    Exit
}

$pwd = $password | ConvertTo-SecureString -AsPlainText -Force
$creds = New-Object pscredential -ArgumentList ($username , $pwd)

try
{
    $log += "Trying to connect with $Cluster_Name"
    if(New-SSHSession -Computer $Cluster_IP -Credential $creds -AcceptKey)
    {
        $session = (Get-SSHSession).SessionId
        Write-Host "SSH session established with $Cluster_Name"
        $log += "SSH session established with $Cluster_Name"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "SSH session established with $Cluster_Name" -table $table
    }
    else
    {
        Write-Host "Failed to establist SSH session with $Cluster_Name"
        Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to establist SSH session with $Cluster_Name" -table $table -asign_grp $storage_sysID
        $log += "Failed to establist SSH session with $Cluster_Name"
        End-log -logcontent $log -logpath $log_path
        Exit
    }

}
catch
{
    Write-Host "Failed to establist SSH session with $Cluster_Name"
    Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to establist SSH session with $Cluster_Name" -table $table -asign_grp $storage_sysID
    $log += "Failed to fetch Ticket details"
    End-log -logcontent $log -logpath $log_path
    Exit
}
try
{
    $log += "Fetching Quota list"
    $Pre_Check = Invoke-SSHCommand -SessionId $session -Command "isi quota quotas list --path=$Directory_Path -v"
    $Pre_Check.Output | Out-File -FilePath "$path\Command_Output\Pre_Check.txt"
    if(($Pre_Check.ExitStatus -eq 0) -and ($Pre_Check.Output.Length -ge 1))
    {
        $Pre_Data              = ($Pre_Check.Output[2]).split("") | ?{$_ -ne ""}
        $Pre_type              = $Pre_Data[0]
        $Pre_directory_name    = $Pre_Data[2]
        $Pre_hard_link         = $Pre_Data[4]
        $Pre_current_hard_type = $Pre_hard_link[-1]
        $Pre_soft_link         = $Pre_Data[5]
        $Pre_advisory_Size     = $Pre_Data[6]

        Write-Host "Quota details fetched - Current Size of the share $Directory_Path is $Pre_hard_link"
        $log += "Quota details fetched - Current Size of the share $Directory_Path is $Pre_hard_link"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Quota details fetched - Current Size of the share $Directory_Path is $Pre_hard_link" -table $table
    }
    else
    {
        Write-Host "Failed to fetch Quota details"
        Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to fetch Quota details" -table $table -asign_grp $storage_sysID
        $log += "Failed to fetch Quota details"
        End-log -logcontent $log -logpath $log_path
        Exit
    }
}
catch
{
    Write-Host "Failed to fetch Quota details"
    Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to fetch Quota details" -table $table -asign_grp $storage_sysID
    $log += "Failed to fetch Quota details"
    End-log -logcontent $log -logpath $log_path
    Exit
}

$log += "Generating Pre evidence"
$execDate=get-date -Format "MM_dd_yyyy_HH_mm"   

$Pre_body = @()
            $Pre_body +="<HTML>
            <HEAD><TITLE>Quota Space Expansion</TITLE></HEAD>
            <BODY>

            <h1><b>
                        <center>Quota Space Expansion</center>
                    </b></h1>
                <table width=100% border=1>
            <tr> <br> </tr>
            <tr>
                <th class='label' colspan=2> Baseline Information </th>
            </tr>
            <tr>
                <td><b> Cluster Name </b></td>
                <td>$Cluster_Name</td>
            </tr>
            <tr>
                <td><b> Share Path </b></td>
                <td>$($Pre_directory_name)</td>
            </tr>   
            <tr>
                <td><b> Current Size </b></td>
                <td>$($Pre_hard_link)</td>
            </tr>     
            <tr>
                <td><b> Executed at </b></td>
                <td>$execDate</td>
            </tr>           
            <tr>
                <td><b> Executed By </b></td>
                <td>$username</td>
            </tr>   
            </body></html>"
            $Pre_body | Out-File "$path\Evidence\Pre_check.html"
            & $wkhtmltopdf $var $pre_html $pre_pdf
$log += "Pre evidence uploaded successfully"
$pre_pdf = Get-ChildItem -Path $pre_pdf
$pre_FullName  = $pre_pdf.FullName               
$pre_Name      = $pre_pdf.Name
try
{
    Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $pre_Name -pre_FullName $pre_FullName -table $table
    $log += "Uploaded Pre Attachement"
}
catch
{
    write-Host "Failed to Upload Pre Attachment"
    $Log += "Failed to Upload Pre Attachment"
    try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Pre Attachment" -table $table -asign_grp $storage_sysID}
    catch{Write-Host "Failed to Route Ticket"}
    Exit
}

if($Pre_current_hard_type -match "G")
{
    "GB"
    $hard_link = ($Pre_hard_link -split "G")[0]
    $new_Size  = [double] $req_Size + $hard_link
    $new_Hard_link =[math]::Round($new_Size,2)
    $advisory_limit =  $new_Size * (90 / 100)
    $advisory_limit =[math]::Round($advisory_limit,2)
    if($new_Size -ge 1024)
    {
        $new_Hard_link_gb = $new_Hard_link/1024
        $new_Hard_link_gb =  [math]::Round($new_Hard_link_gb,2)
    }
    (Invoke-SSHCommand -SessionId $session -Command "isi quota quotas modify --path=$Directory_Path --hard-threshold=$($new_Hard_link)GB --advisory-threshold=$($advisory_limit)GB --type directory").output
}
elseif($Pre_current_hard_type -match "T")
{
    "TB"
    $hard_link = ($Pre_hard_link -split "T")[0]
    $current_Hard_Link = 1024*$hard_link
    $new_Size  = [double] $req_Size + $current_Hard_Link
    $new_Hard_link =[math]::Round($new_Size,2)
    $advisory_limit =  $new_Size * (90 / 100)
    $advisory_limit = [math]::Round($advisory_limit,2)
    (Invoke-SSHCommand -SessionId $session -Command "isi quota quotas modify --path=$Directory_Path --hard-threshold=$($new_Hard_link)GB --advisory-threshold=$($advisory_limit)GB --type directory")
    $new_Hard_link_gb = $new_Hard_link/1024
    $new_Hard_link_gb = [math]::Round($new_Hard_link_gb,2)
}

try
{
    $log += "Fetching Post Quota list"
    $Post_Check = Invoke-SSHCommand -SessionId $session -Command "isi quota quotas list --path=$Directory_Path -v"
    $Post_Check.Output | Out-File -FilePath "$path\Command_Output\Post_check.txt"
    if(($Post_Check.ExitStatus -eq 0) -and ($Post_Check.Output.Length -ge 1))
    {
        $Post_Data = ($Post_Check.Output[2]).split("") | ?{$_ -ne ""}
        $Post_type = $Post_Data[0]
        $Post_directory_name = $Post_Data[2]
        $Post_hard_link = $Post_Data[4]
        $Post_current_hard_type = $post_hard_link[-1]
        $Post_soft_link = $Post_Data[5]
        $Post_advisory_Size = $Post_Data[6]
        Write-Host "Post Quota details fetched"
        $log += "Post Quota details fetched"

    }
    else
    {
        Write-Host "Failed to fetch Post Quota details"
        Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to fetch Post Quota details" -table $table -asign_grp $storage_sysID
        $log += "Failed to fetch Post Quota details"
        End-log -logcontent $log -logpath $log_path
        Exit
    }
}
catch
{
    Write-Host "Failed to fetch Post Quota details"
    Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to fetch Post Quota details" -table $table -asign_grp $storage_sysID
    $log += "Failed to fetch Post Quota details"
    End-log -logcontent $log -logpath $log_path
    Exit
}

if($Post_current_hard_type -match "G")
{
    "GB"
    $Post_hard_link_print = $Post_hard_link
    $Post_hard_link = ($Post_hard_link -split "G")[0]
	$Post_hard_link = [double] $Post_hard_link
    #$Size_Check = $req_Size + $hard_link
    if([double]$Post_hard_link -eq $new_Hard_link)
    {
        Write-Host "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print"
        $log += "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print" -table $table
    }
    else
    {
        Write-Host "Volume modify not successful "
        Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Volume modify not successful" -table $table -asign_grp $storage_sysID
        $log += "Volume modify not successful"
        End-log -logcontent $log -logpath $log_path
        Exit
    }
}
elseif($Post_current_hard_type -match "T")
{
    "TB"
    $Post_hard_link_print = $Post_hard_link
    $Post_hard_link = ($Post_hard_link -split "T")[0]
	$Post_hard_link = [double] $Post_hard_link
    #$post_hard_link_divided = $Post_hard_link_TB/1024
    #$Post_Updated_Hard_Link = 1024*$Post_hard_link
    #$Post_Hard_link_GB =[math]::Round($Post_Updated_Hard_Link,2)
    #$Size_Check  = $req_Size + $current_Hard_Link
    #$Post_hard_link_GB = $Post_hard_link_1/1024
    #$Post_Hard_link_GB =[math]::Round($Post_Hard_Link_GB,2)
    if($Post_Hard_link -eq $new_Hard_link_gb)
    {
        Write-Host "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print"
        $log += "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Volume Modified Successfully - Updated Size of the share $Directory_Path is $Post_hard_link_print" -table $table
    }
    else
    {
        Write-Host "Volume modify not successful"
        Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Volume modify not successful" -table $table -asign_grp $storage_sysID
        $log += "Volume modify not successful"
        End-log -logcontent $log -logpath $log_path
        Exit
    }
}

$log += "Generating Post evidence"

$Post_body = @()
    $Post_body +="<HTML>
    <HEAD><TITLE>Quota Space Expansion</TITLE></HEAD>
    <BODY>
    <h1><b>
        <center>Quota Space Expansion</center>
        </b></h1>
    <table width=100% border=1>
    <tr> <br> </tr>
    <tr>
        <th class='label' colspan=2> Baseline Information </th>
    </tr>
    <tr>
        <td><b> Cluster Name </b></td>
        <td>$Cluster_Name</td>
    </tr>
    <tr>
        <td><b> Share Path </b></td>
        <td>$($Post_directory_name)</td>
    </tr>   
    <tr>
        <td><b> Current Size </b></td>
        <td>$($Post_hard_link_print)</td>
    </tr>     
    <tr>
        <td><b> Executed at </b></td>
        <td>$execDate</td>
    </tr>           
    <tr>
        <td><b> Executed By </b></td>
        <td>$username</td>
    </tr>   
    </body></html>"
    $Post_body | Out-File "$path\Evidence\Post_Check.html"
    & $wkhtmltopdf $var $post_html $post_pdf

#Uploading post evidence
$post_pdf = Get-ChildItem -Path $post_pdf
$post_FullName = $post_pdf.FullName
$post_Name     = $post_pdf.Name

try
{
    Upload-PostAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -post_Name $post_Name -post_FullName $post_FullName -table $table
    $log += "Uploaded Pre Attachement"
    Start-Sleep -Seconds 5
}
catch
{
    write-Host "Failed to Upload Post Attachment"
    $Log += "Failed to Upload Post Attachment"
    try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Post Attachment" -table $table -asign_grp}
    catch{Write-Host "Failed to Route Ticket"}
    Exit
}

$log += "Post evidence uploaded successfully"
try{
Update-End -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table
Resolve-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Quota Space Expanded as per request. Closing the ticket" -Document_Results "Quota Space Modified Successfully" -close_Notes "Quota Space Modified Successfully" -table $table
}
catch{Write-Host "Failed to Resolve Ticket"; Exit}
End-log -logcontent $log -logpath $log_path

Post Execution:

if(Process[OpName].scriptOutput.indexOf('Ticket Resolved Successfully') >= 0)
{
  Process.ReturnCode = 0
  Process.ReturnMessage = "Ticket Resolved Successfully"
}
else if(Process[OpName].scriptOutput.indexOf('Assignment Group updated successfully') >= 0)
{
  Process.ReturnCode = 0
Process.ReturnMessage = "Assignment Group updated successfully"
}
else 
{
	Process.ReturnCode = 2
	Process.ReturnMessage = "Some error occurred."
}
