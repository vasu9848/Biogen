1. Get Ticket

Pre Execution:

var uri="https://"+Process.SnowEnv+".service-now.com/api/now/table/incident?sysparm_fields=number%2Cactive%2Csys_id%2Cincident_state%2Cdescription%2Cassigned_to=SVC-itpam@biogen.com&sysparm_limit=1&number="+Process.incidentNumber
Process.url=uri

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket details fetched successfully"
  Process.Output=Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=1;
  Process.ReturnMessage="Failure fetching ticket details"
}

2.Second Operator (Read Ticket)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('incident_state')>=0)
  {Process.Incidentstate=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active)
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=1;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Ticket Update

Pre Execution:

Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><incident_state>2</incident_state><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes></entry></request>"
Process.putURL="https://"+Process.SnowEnv+".service-now.com/api/now/v2/table/incident/"+Process.Sys_Id+"?sysparm_fields=incident_state"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}

4.Script

Inline:

Test-Connection -ComputerName $args[0] -Quiet

Post Execution:

if(Process.Ping_Check.scriptOutput.indexOf("True")>=0)
{
  Process.ReturnCode=0
}
else if(Process.Ping_Check.scriptOutput.indexOf("False")>=0)
{
  Process.ReturnCode=-1
  Process.ReturnMessage="Connection to target CI not succesful, routing Incident to “UNIX” Assignment Group"
}
else
{
Process.ReturnCode=1
Process.returnMessage = "Fatal Error"
}

5. Update Ticket (Ping Status)

Success:

Pre Execution:

Process.PingPayload="<request><entry><work_notes>Target CI Reached Successfully</work_notes></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}

Failure:

Pre Execution:

Process.PingFailPayLoad ="<request><entry><work_notes>Target CI is not Reachable</work_notes><assignment_group>d32d41c5dbe73e00d41dd3cb5e96194f</assignment_group></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}

6.Script

Inline:

param
($computer,
$INCNumber,
$RDPUsername,
$RDPPassword,
$Drive)

$pwd = $RDPPassword | ConvertTo-SecureString -AsPlainText -Force
$creds = New-Object pscredential -ArgumentList ($RDPUsername , $pwd)

function timestamp{
    Get-Date -Format "dd_MMM_yyyy_HH:mm:ss tt"
}

$log_path = "D:\Incident\Application_Drive\$INCNumber\logs"

$log=@()
$log += "-----------------"
$log += "Script Execution Started at $(timestamp)"
$log += "Service Account used for remediation is Svc-ITPAM"


$filePath= "D:\Incident\Application_Drive\$INCNumber\logs"
If(!(test-path $log_path))
{
      New-Item -ItemType Directory -Force -Path $filePath 
}

    $driveObj = Get-WmiObject -Class Win32_LogicalDisk -ComputerName $computer -Credential $creds -Filter "DriveType = '3'" | Where-Object {$_.DeviceID -eq $Drive+":"} | Select-Object Name, Size, FreeSpace, VolumeName
    foreach($drive in $driveObj)
    {
        $total_size = [math]::round($drive.Size/1GB, 0)
        $free_size = [math]::round($drive.FreeSpace/1GB, 0)
        $free_percbentage =[math]::Round((($free_size/$total_size))*100,1)

        if($free_percbentage -le 10)
        {
            Write-Host "Above"
            $log += "Current $($drive.Name) drive space is $free_percbentage % which is above the threshold limit"
        }
        else
        {
            Write-Host "Utilization is below"
            $log += "Current $($drive.Name) drive space is $free_percbentage % which is below the threshold limit"

"What is the Issue : $($drive.Name) drive free space is less than the threshold limit.

Cause of the issue or Analysis:  The application files consuming more space. Whcih casused the application drive to consume more space than the defined threshold limit

Action taken : None

Current status : Now the free space is $free_percbentage %, Hence resolving the incident" | Out-File "D:\Incident\Application_Drive\$INCNumber\Close_notes.txt"
        }
    }


$log += "Script Execution Ends $(timestamp)"
$log += "-----------------"
$log | Add-Content $log_path\log.txt

Post Execution:

if(Process[OpName].scriptOutput.indexOf("Utilization is below")>=0)
{
  Process.ReturnCode=3
  Process.ReturnMessage="Drive Utilization is Below threshold limit."
  Process.Utilization = "Low"
}
else if(Process[OpName].scriptOutput.indexOf("Above")>=0)
{
  Process.ReturnCode=5
  Process.ReturnMessage ="The Utilization is above the threshold limit"
}
else if(Process[OpName].scriptOutput.indexOf("Failed to fetch the Drive Status")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to fetch the Drive Status"
}
else
{
Process.ReturnCode=-1
Process.returnMessage = "Fatal Error"
}


7.Ticket Update

Success:

Pre Execution:

Process.CPUHighPayLoad= "<request><entry><work_notes>"+Process.ReturnMessage+"</work_notes></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}

Failure:

Pre Execution:

Process.FatalErrorPayLoad ="<request><entry><work_notes>Automation Failed, Routing the Ticket to Windows Assignmenet Group</work_notes><assignment_group>d32d41c5dbe73e00d41dd3cb5e96194f</assignment_group></entry></request>"

Another Operator Failure:

Pre Execution:

Process.putURL="https://biogendev.service-now.com/api/now/v2/table/incident/"+Process.Sys_Id+"?sysparm_fields=incident_state"

if(Process.Utilization == "Low")
{
Process.Final = "<request><entry><work_notes>"+Process.Scenario+" Utilization is below the threshold level, hence resolving the ticket.</work_notes><incident_state>6</incident_state></entry></request>"
}
else
{
Process.Final = "<request><entry><work_notes>"+Process.Scenario+" Utilization is still above threshold level, hence routing the ticket to Windows Queue. </work_notes><assignment_group>d32d41c5dbe73e00d41dd3cb5e96194f</assignment_group></entry></request>"
}

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}

8.Script

Inline:

param
($serverName,
$INCNumber,
$SNOW_Env,
$RDPUsername,
$RDPPassword)


function timestamp{
    Get-Date -Format "dd_MMM_yyyy_HH:mm:ss tt"
}

$log_path = "D:\Incident\Application_Drive\$INCNumber\logs"

$log=@()
$log += "-----------------"
$log += "Script Execution Started at $(timestamp)"

If(!(test-path $log_path))
{
      New-Item -ItemType Directory -Force -Path $log_path 
}

$pwd = $RDPPassword | ConvertTo-SecureString -AsPlainText -Force
$creds = New-Object pscredential -ArgumentList ($RDPUsername , $pwd)

$username = $creds.UserName
$execDate=get-date -Format "MM_dd_yyyy_HH_mm" 

$body = @()
$body +="<HTML>
<HEAD><TITLE>SERVER STATUS</TITLE></HEAD>
<BODY>

<h1><b>
            <center>Server Health Check Status</center>
        </b></h1>
    <table width=100% border=1>
<tr> <br> </tr>
        <tr>
            <th class='label' colspan=2> Server Baseline Information </th>
        </tr>
        <tr>
            <td><b> Host Name </b></td>
            <td>$serverName</td>
        </tr>
        <tr>
            <td><b> Executed at </b></td>
            <td>$execDate</td>
        </tr>           
        <tr>
            <td><b> Executed By </b></td>
            <td>$username</td>
        </tr>"

try
{
    $driveObj = Get-WmiObject -Class Win32_LogicalDisk -ComputerName $serverName -Credential $creds -Filter "DriveType = '3'" | Where-Object {$_.DriveType -eq 3 -and $_.DeviceID -ne 'C:'} | Select-Object Name, Size, FreeSpace, VolumeName
    foreach($drive in $driveObj)
    {
        $total_size = [math]::round($drive.Size/1GB, 0)
        $free_size = [math]::round($drive.FreeSpace/1GB, 0)
        $free_percbentage =[math]::Round((($free_size/$total_size))*100,1)
        $body += "
        <tr>
            <td><b> $($drive.Name) </b></td>
            <td>$free_size GB ($free_percbentage %)</td>
        </tr>"
    }
}
catch
{
    Write-Host "Failed to fetch the drive details"
    $log += "Failed to fetch the drive details"
}
$body +="</tr>
 </body></html>"
 
$body | Out-File "D:\Incident\Application_Drive\$INCNumber\HealthCheckReport.html"

try
{
$wkhtmltopdf = "D:\wkhtmltopdf\bin\wkhtmltopdf.exe"
$var = "-q"
$html = "D:\Incident\Application_Drive\$INCNumber\HealthCheckReport.html"
$pdf = "D:\Incident\Application_Drive\$INCNumber\HealthCheckReport.pdf"
& $wkhtmltopdf $var $html $pdf
$log += "Successfully Converted HTML file to PDF Format"
write-Host "Successfully Converted HTML file to PDF Format"
}
catch
{
$log += "Failed to convert the HTML file to PDF"
Write-Host "Failed to convert the HTML file to PDF"
}

$log += "Script Execution Ends $(timestamp)"
$log += "-----------------"
$log | Add-Content $log_path\log.txt


Post Execution:

if(Process[OpName].scriptOutput.indexOf("Successfully Converted HTML file to PDF Format")>=0)
{
  Process.ReturnCode=5
  Process.ReturnMessage ="Successfully Converted HTML file to PDF Format"
}
else if(Process[OpName].scriptOutput.indexOf("Failed to Generate Report")>=0)
{
  Process.ReturnCode=-1
  Process.ReturnMessage="Failed to Generate Report"
}
else if(Process[OpName].scriptOutput.indexOf("Unable to take a Remote Session")>=0)
{
  Process.ReturnCode=-1
  Process.ReturnMessage="Unable to take a Remote Session"
}
else if(Process[OpName].scriptOutput.indexOf("Failed to write HTML File")>=0)
{
  Process.ReturnCode=-1
  Process.ReturnMessage="Failed to write HTML File"
}
else if(Process[OpName].scriptOutput.indexOf("Failed to convert the HTML file to PDF")>=0)
{
  Process.ReturnCode=-1
  Process.ReturnMessage="Failed to convert the HTML file to PDF"
}
else
{
Process.ReturnCode=-1
Process.returnMessage = "Fatal Error"
}


9.Script

Inline:

Param($INC_Number)
$file = Get-ChildItem "D:\Incident\Application_Drive\$($INC_Number)\*.pdf"

if($file)
{
write-Host "PDF File Exist"
$fullPath = $file.FullName 
$fileName = $file.Name
$fullPath
$fileName 
}
else
{write-host "PDF file doesnot exist"}

Post Execution:

if(Process[OpName].scriptOutput.indexOf("PDF File Exist")>=0)
{
Process.ReturnCode = 0
Process.ReturnMessage = "PDF Generated successfully"
Process.Data = Process[OpName].scriptOutput
}
else if(Process[OpName].scriptOutput.indexOf("PDF file doesnot exist")>=0)
{
Process.ReturnCode = 2
Process.ReturnMessage = "PDF file doesnot exist."

}
else if(Process.Utilization = "Low")
{
Process.ReturnMessage = "Utilization is Below Threshold"
Process.ReturnCode = 5
}
else
{
Process.ReturnCode=2
Process.ReturnMessage = "Fatal Error."
}


10.Ticket Update

Pre Execution:

Process.dat=Process.PDF_Report.scriptOutput.split('\n')
Process.fname=Process.dat[2]
Process.pdffile=Process.dat[1]

//Process.putURL= "https://"+Process.Instance+".service-now.com/api/now/attachment/file?table_name=change_task&table_sys_id="+Process.Sys_Id+"&file_name="+Process.fname


Process.postURL= "https://"+Process.SnowEnv+".service-now.com/api/now/attachment/file?table_name=incident&table_sys_id="+Process.Sys_Id+"&file_name="+Process.fname
//Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"


Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="Created" && Process[OpName].HTTPResponseStatusCode==201 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="PDF updated successfully."
  if(Process.Utilization == "Low")
  {
		Process.ReturnCode=9;
  }
	else
	{
		Process.ReturnCode=0
	}
}else if(Process[OpName].Reason.indexOf('non-success') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent

}
else if(Process[OpName].Reason.indexOf('failure') >= 0){
	Process.ReturnCode =2;
  Process.ReturnMessage = Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Error occurred while uploading PDF file to Service Now."
  
}

11. Script

Proceed:

Inline:

Param($INC_Number)
Get-Content "D:\Incident\Application_Drive\$INC_Number\Close_notes.txt"

Post Execution:

if(Process[OpName].scriptOutput.indexOf("Assignment Group updated successfully")>=0)
{
  Process.ReturnCode=9
  Process.route = "Success"
  Process.ReturnMessage ="Assignment Group updated successfully"
}
else if(Process[OpName].scriptOutput.indexOf("Notification mail sent successfully to ITSO")>=0)
{
  Process.ReturnCode=5
  Process.ReturnMessage ="Notification mail sent successfully to ITSO"
}

else if(Process[OpName].scriptOutput.indexOf("Notified the Windows team")>=0)
{
  Process.ReturnCode=5
  Process.ReturnMessage="Notified the Windows team"
}

else if(Process[OpName].scriptOutput.indexOf("Failed to Notify Windows Team")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to Notify Windows Team"
}

else if(Process[OpName].scriptOutput.indexOf("Failed to Send mail notification to ITSO")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to Send mail notification"
}

else if(Process[OpName].scriptOutput.indexOf("ITSO Email is not available")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="ITSO Email is not available"
}

else if(Process[OpName].scriptOutput.indexOf("No Application is hosted")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="No Application is hosted"
}

else if(Process[OpName].scriptOutput.indexOf("Failed to Fetch ITSO Information")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to Fetch ITSO Information"
}

else if(Process[OpName].scriptOutput.indexOf("Failed to fetch the Server information from CMDB")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to fetch the Server information from CMDB"
}

else if(Process[OpName].scriptOutput.indexOf("Failed to fetch the Application details mapped witht the server")>=0)
{
  Process.ReturnCode=7
  Process.ReturnMessage="Failed to fetch the Application details mapped witht the server"
}

else
{
Process.ReturnCode=-1
Process.returnMessage = "Fatal Error"
}


12.Script 

Success:

Inline:

Param($INC_Number)
Get-Content "D:\Incident\Application_Drive\$INC_Number\Close_notes.txt"

Post Execution:

if(Process[OpName].scriptOutput.indexOf("What is the Issue :")>=0)
{
Process.ReturnCode = 0
Process.ReturnMessage = "Close Codes file retrived successfully"
Process.Data = Process[OpName].scriptOutput
}
else if(Process[OpName].scriptOutput.indexOf("Get-Content")>=0)
{
Process.ReturnCode = 2
Process.ReturnMessage = "Failed to update the CLose codee"
}
else
{
Process.ReturnCode=2
Process.ReturnMessage = "Fatal Error."
}


13.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SnowEnv+".service-now.com/api/now/v2/table/incident/"+Process.Sys_Id+"?sysparm_fields=incident_state"

if(Process.Utilization == "Low")
{
Process.Final = "<request><entry><close_code>Solved (Permanently)</close_code><u_knowledge_issues>true</u_knowledge_issues><u_knowledge_issue_type>2</u_knowledge_issue_type><close_notes>"+Process.PDF_Report_1_1.scriptOutput+"</close_notes><u_comments>Ticekt Resolved Successfully</u_comments><u_repeat_incident>No</u_repeat_incident><work_notes>The Application Drive Utilization is  below the threshold level, hence resolving the ticket.</work_notes><incident_state>6</incident_state></entry></request>"
}
else if(Process.route == "success")
{
Process.ReturnMessage = "Ticket Updated accordingly."
}
else
{
Process.Final = "<request><entry><assigned_to></assigned_to><work_notes>The Application Drive Utilization is above threshold level, hence routing the ticket to Windows Queue. </work_notes><assignment_group>d32d41c5dbe73e00d41dd3cb5e96194f</assignment_group></entry></request>"
}


Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("incident_state\":\"")>=0)
  {
	Process.ReturnCode=1;
	Process.ReturnMessage="Ticket resolved successfully ";
  }
  else
  {
	Process.ReturnCode=-1;
	Process.ReturnMessage="Error occurred while  resolving ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while resolving ticket"
}




