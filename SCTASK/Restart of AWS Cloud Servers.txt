1. Get Ticket

Pre Execution:

Process.url = "https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task?number="+Process.Number

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket details fetched successfully"
  Process.Output=Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Failure fetching ticket details"
}

2. Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('state')>=0)
  {Process.state=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active=='true')
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket updated successfully ";
  }
  else
  {
	Process.ReturnCode=2;
	Process.ReturnMessage="Error occurred while  updating ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while updating ticket."
}

4.Script

Pre Execution:

Process.ReturnMessage = "iAutomate is checking if the current time is within the 15-minute window from the planned schedule to proceed with the stop";

Inline:

try{
    $ErrorActionPreference = "Stop"

	$plannedDT = $args[0]

	Write-Host $plannedDT
 
    #$plannedDT = "08-17-2025 05:50:12 PM"

    if($plannedDT){
        $proceed = "No"
 
        $timeZone = (Get-TimeZone).Id
        $dateTime = Get-Date -Format "MM-dd-yyyy HH:mm:ss"

        if($timeZone -ne "Eastern Standard Time"){
            $dateTimeInUTC = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId($dateTime, $timeZone, "UTC")
            $estTimeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("Eastern Standard Time")
            $dateTimeInEST = [System.TimeZoneInfo]::ConvertTimeFromUtc($dateTimeInUTC, $estTimeZone)
            $dateTime = $dateTimeInEST.ToString('MM-dd-yyyy HH:mm:ss')
 
            $proceed = "Yes"
        }
 
        if($proceed -eq "Yes"){
            $dateTime = Get-Date -Date $dateTime -Format "MM-dd-yyyy HH:mm:ss"
            $plannedDateTime = Get-Date -Date $plannedDT -Format "MM-dd-yyyy HH:mm:ss"
            $bufferEndOfWindow = (Get-Date -Date $plannedDateTime).AddMinutes(15)
            $endOfWindow = Get-Date -Date $bufferEndOfWindow -Format "MM-dd-yyyy HH:mm:ss"
 
            if(($dateTime -ge $plannedDateTime) -and ($dateTime -lt $endOfWindow)){
                Write-Host "True::iAutomate validation completed. The current time ($dateTime) falls within the 15-minute execution window (from $plannedDateTime to $endOfWindow). Proceeding with the server stop."
            }
            else{
                Write-Host "False::iAutomate validation completed. The current time ($dateTime) has exceeded the 15-minute execution window (ended at $endOfWindow). Server stop will not proceed."
            }
        }
        else{
            Write-Host "False::iAutomate encountered an error while validating the 15-minute execution window. Failed to convert the current time zone '$timeZone' to Eastern Standard Time. Cannot proceed."
        }
    }
    else{
        Write-Host "False::iAutomate encountered an error while validating the 15-minute execution window. Planned DateTime field is empty. Cannot proceed with execution."
    }
}
catch{
    $errorMessage = $_.Exception.Message
    Write-Host "Error due to::iAutomate encountered an unexpected error while validating the 15-minute execution window. $errorMessage"
}

Post Execution:

if((Process[OpName].scriptOutput.indexOf("True") >= 0) || (Process[OpName].scriptOutput.indexOf("False") >= 0)  || (Process[OpName].scriptOutput.indexOf("Error due to") >= 0)){
    Process.TFetchout = Process[OpName].scriptOutput.trim();
    Process.TFetchout1 = Process.TFetchout.split("::");
    Process.TFetchout2 = Process.TFetchout1[1];

  	if(Process[OpName].scriptOutput.indexOf("True") >= 0){
	  	Process.ReturnMessage = Process.TFetchout2;
	  	Process.ReturnCode = 0;
  	}
  	else if(Process[OpName].scriptOutput.indexOf("False") >= 0){
	  	Process.ReturnMessage = Process.TFetchout2;
	  	Process.ReturnCode = 2;
  	}
  else{ 
		Process.ReturnMessage = Process.TFetchout2;
	  	Process.ReturnCode = 2;
  	}
}
else{
    Process.ReturnMessage = "iAutomate failed to validate whether the current time falls within the 15-minute execution window from the planned time\n" + Process[OpName].scriptOutput ;
  	Process.ReturnCode = 2;
}

5.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.payload = "<request><entry><work_notes>"+Process.ReturnMessage+"</work_notes></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket updated successfully ";
  }
  else
  {
	Process.ReturnCode=2;
	Process.ReturnMessage="Error occurred while  updating ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while updating ticket."
}



6.Script

Inline:

####RESTART

#If running - Restart, ping(after), compare uptime before and after for validation
#stopped - Start and ping alone

Param(
$Number,
$username,
$pass1,
$snowkey,
$snowp,
$snowpa,
$SNOW_Env,
$ins_ids,
$av_zone,    
$account,  
$Environment,
$IP_addressess,  
$hosts,
$os,
$rdpusername,
$rdppassword
)

$Number
$username
$snowkey
$SNOW_Env
$ins_ids
$av_zone    
$account  
$Environment
$IP_addressess  
$hosts
$os
$rdpusername

Import-Module "D:\Wave 1 Scripts\Biogen_Module\Biogen_Module.psm1"

$script_name = "Server_restart_Cloud"
$UNIX = "5b2d41c5dbe73e00d41dd3cb5e961955"
$Windows = "d32d41c5dbe73e00d41dd3cb5e96194f"
$snowpass = "$snowp"+"#%4"+$snowpa+"_"
$computer = "10.240.151.74"
$keyfile  = "D:\ssh.key"
$pass = $pass1 + "%"
$pwd = $pass | ConvertTo-SecureString -AsPlainText -Force
$credsss = New-Object pscredential -ArgumentList ($username, $pwd)
$table = "sc_task"
$path = "D:\$script_name\$Number"
$Kion_user = "ia-role"

$rdppwd = $rdppassword | ConvertTo-SecureString -AsPlainText -Force
$cred = New-Object pscredential -ArgumentList ($rdpusername, $rdppwd)

if($os -contains "Windows")
{
    $assign = $Windows
}
elseif($os -contains "LINUX")
{
    $assign = $UNIX
}
$filePaths = "$path\Pre_log","$path\Post_log"
foreach($filePath in $filePaths)
{
    If(!(test-path $filePath))
    {
        New-Item -ItemType Directory -Force -Path $filePath 
    }
    If(!(test-path "$filePath\log.txt"))
    {
        New-Item -ItemType File -Name "Log.txt" -Path $filePath
    }
}

try
{
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $global:headers = @{"Authorization" = "Basic "+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($snowkey+":"+$snowpass))}
    
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $get_inc = "https://$SNOW_Env.service-now.com/api/now/v2/table/$($table)?number=$Number"
    $inc_result = Invoke-WebRequest -Uri $get_inc -Headers $global:headers -Method Get -ContentType "application/json" -UseBasicParsing
    $incout = $inc_result | ConvertFrom-JSON
    $inc_sysid = $incout.result.sys_id
    $description = $incout.result.description
}
catch
{
    Write-Host "Failed to fetch Ticket details"
    $log += "Failed to fetch Ticket details"
    Exit
}

if($description -match ",")
{
    $hostname_count = ($hosts.Split(",")).Count
    $hosts          = ($hosts.Split(",") | ?{$_ -ne ""}).Trim()
    $insids         = ($ins_ids.Split(",") | ?{$_ -ne ""}).Trim()
    $av_zone        = ($av_zone.Split(",") | ?{$_ -ne ""}).Trim()
    $account        = ($account.Split(",") | ?{$_ -ne ""}).Trim()
    $os             = ($os.Split(",") | ?{$_ -ne ""}).Trim()
    $Environment    = ($Environment.Split(",") | ?{$_ -ne ""}).Trim()
    $IP_address     = ($IP_addressess.Split(",") | ?{$_ -ne ""}).Trim()
}
else
{
    $hostname_count = $hosts.Count
    $hosts          = @($hosts)
    $insids         = @($ins_ids)
    $av_zone        = @($av_zone)
    $account        = @($account)
    $os             = @($os)
    $Environment    = @($Environment)
    $IP_address     = @($IP_addressess)
}

$KIONS   = @()

for($i=0; $i -lt $hostname_count; $i++)
{
    $KIONS             += [PSCustomObject]@{
        "Hosts"       = $($hosts[$i])
        "Insids"      = $($insids[$i]) 
        "Av_zone"     = $($av_zone[$i])
        "account"     = $($account[$i])
        "os"          = $($os)
        "Environment" = $($Environment[$i])
        "IP_address"  = $($IP_address[$i])
    }
}

function timestamp{
    Get-Date -Format "dd_MMM_yyyy_HH:mm:ss tt"
}

Add-Content -Path "$path\Pre_log\Log.txt" -Value "-----------------"
Add-Content -Path "$path\Pre_log\Log.txt" -Value "Script Execution Started at $(timestamp)"
Add-Content -Path "$path\Pre_log\Log.txt" -Value "Service Account used for execution is Svc-ITPAM"

$Pre_current_Status  = @()
$current_Status      = @()
$Pre_Launch_Time     = @()
$host_session        = @()
$host_Session_ID     = @()
$Pre_Running         = @()
$reboot_running      = @()
$initiate_reboot     = @()
$Success_server_info = @()
$Pre_Failed          = @()
$Pre_current_Status  = @()
$Already_Stopped     = @()
$reboot_stopped      = @()
$initiate_Start      = @()
$Not_Stopped         = @()
$current_Pre_Status  = @()
$Post_Launch_Time    = @()
$Post_current_Status = @()
$post_Environment    = @()
$post_Account        = @()
$Post_current_Status = @()
$Post_Failed         = @()

try
{
    if($error)
    {
        $error.Clear()
    }
    
    New-SSHSession -Computer $computer -Credential $credsss -AcceptKey #-Keyfile $keyfile -AcceptKey
    $session = (Get-SSHSession).SessionId
    
    if($error)
    {
        Write-Host "Failed to establish connection with $computer"
        $log += "Failed to establish connection with $computer"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to establish SSH connection." -asign_grp $assign -table $table}
        catch{Write-Host "Failed to Route Ticket"; Exit}
        Exit
    }
    Write-Host "Session Established Successfully with $computer" -ForegroundColor Green        
    $log += "Session Established Successfully with $computer"
    Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "SSH Session Established Successfully. `n `n $start_Successful" -table $table
}
catch
{
    Write-Host "Failed to establish connection with $computer"
    $log += "Failed to establish connection with $computer"
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to establish SSH connection." -asign_grp $assign -table $table}
    catch{Write-Host "Failed to Route Ticket"; Exit}
    Exit
}


foreach($KION in $KIONS)
{

    $Pre_Launch_Time = ""
    $Pre_current_Status = ""

	#$hostname_count
	$KION.hosts       
    $KION.insids      
    $KION.av_zone     
    $KION.account     
    $os      
    $KION.Environment 
    $KION.IP_address

    Add-Content -Path "$path\Pre_log\Log.txt" -Value "-----------------"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Server Number is $i"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Hostname: $($KION.hosts)"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Instance ID: $($KION.insids)"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Availability Zone: $($KION.av_zone)"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "AWS Account ID: $($KION.account)"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "OS: $os"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Environment: $($KION.Environment)"
    Add-Content -Path "$path\Pre_log\Log.txt" -Value "IP Address: $($KION.IP_address)"
	write-host $KION.IP_address
    $env = ($KION.Environment)[0]
    write-host "$env"
    #Add-Content -Path "$path\Pre_log\Log.txt" -Value "Environment: $($KION.Environment)"
    if($env -eq "N")
    {
        Write-Host "Non-prod env"
        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Non Prod Env"
        try
        {
            $keys = (Invoke-SSHCommand -SessionId $session -Command "kion --profile nonprod stak --l $($KION.account)  --car $Kion_user -p").Output
            $Access_key = (($keys -split "export AWS_ACCESS_KEY_ID=")[1]).Trim()
            $secret_key = (($keys -split "export AWS_SECRET_ACCESS_KEY=")[2]).Trim()
            $token_ID   = (($keys -split "export AWS_SESSION_TOKEN=")[3]).Trim()
            Write-Host "AWS_ACCESS_KEY_ID $Access_key"
            Write-Host "AWS_SECRET_ACCESS_KEY $secret_key"
            Write-Host "AWS_SESSION_TOKEN $token_ID"

            Write-Host "Setting up environment for $($KION.av_zone)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Setting up environment for $($KION.av_zone)"

            $Set_Access_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_access_key_id $Access_key"
            if($Set_Access_key.ExitStatus -eq "0")
            {
                $Set_Secret_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_secret_access_key $secret_key"
                if($Set_Secret_key.ExitStatus -eq "0")
                {
                    $Set_Session_token = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_session_token $token_ID"
                    if($Set_Session_token.ExitStatus -eq "0")
                    {
                        $Set_Region = Invoke-SSHCommand -SessionId $session -Command "aws configure set region $($KION.av_zone)"
                        if($Set_Region.ExitStatus -eq "0")
                        {
                                
                            Write-Host "Environment setup successfully for $($KION.account)"
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value  "Environment setup successfully for $($KION.av_zone)"
                            $Pre_current_Status = Invoke-SSHCommand -SessionId $session -Command "aws ec2 describe-instances --instance-ids $($KION.insids) --output text --query 'Reservations[*].Instances[*].State.Name'"
						    $Pre_current_Status
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current State of $($KION.hosts) is $($Pre_current_Status.Output) ExitStatus is $($Pre_current_Status.ExitStatus)"
                            if($Pre_current_Status.ExitStatus -eq "0") 
                            {   
                                $current_Status = $Pre_current_Status.Output
                                if($Pre_current_Status.Output -like "*running*")
                                {
                                    if($os -contains "Windows")
                                    {
                                        try
                                        {
                                            $Error.Clear()
                                            $Pre_Launch_Time = Invoke-Command -ComputerName $($KION.hosts) -Credential $cred -ScriptBlock {(gcim Win32_OperatingSystem). LastBootUpTime}
                                            if($Error)
                                            {
                                                $Pre_Launch_Time = "NA"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value $Error.errordetails.Message
                                            }
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                        catch
                                        {
                                            $Pre_Launch_Time = "NA"
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                    }
                                    elseif($os -contains "LINUX")
                                    {
                                        try
                                        {
                                            #Write-Host "New-SSHSession -ComputerName $($KION.IP_address) -Credential $credsss"
                                            $host_session = New-SSHSession -ComputerName $($KION.IP_address) -Credential $credsss -AcceptKey -Force 
                                            #Write-Host "Host session is $host_session"
                                            $host_Session_ID = $host_session.SessionId
                                            $Pre_Launch_Time = Invoke-SSHCommand -SessionId $host_Session_ID -Command "uptime -s"

                                            if($Pre_Launch_Time.ExitStatus -eq "0")
                                            {
                                                Write-Host "Uptime of $($KION.hosts) is $($Pre_Launch_Time.Output)"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $($Pre_Launch_Time.Output)"
                                            }
                                            else
                                            {
                                                $Pre_Launch_Time = "NA"
                                                Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            }
                                            Remove-SSHSession -SessionId $host_session_ID
                                        }
                                        catch
                                        {
                                            $Pre_Launch_Time = "NA"
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                    }

                                    Write-Host "Current Status of $($KION.hosts) is Running. Proceeding to Reboot the server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is Running. Proceeding to Reboot the server."
                                    $Pre_Running += @("$($KION.hosts)")
									$reboot_running = Invoke-SSHCommand -SessionId $session -Command "aws ec2 reboot-instances --instance-ids $($KION.insids) --region $($KION.av_zone)"
                                    $reboot_running 

                                    if($reboot_running.ExitStatus -eq 0)
                                    {
                                        Write-Host "$($KION.hosts) reboot initiated."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "$($KION.hosts) reboot initiated."
                                        $initiate_reboot  += @("$($KION.hosts) `n")
                                        
                                        $Success_server_info  += [PSCustomObject] @{     
                                        "HostName"          = $KION.hosts       
                                        "Instance_ID"       = $KION.insids         
                                        "Availability_Zone" = $KION.av_zone     
                                        "Account"           = $KION.account     
                                        "OS"                = $os      
                                        "Environment"       = $KION.Environment 
                                        "IP_Address"        = $KION.IP_address
                                        "Current_State"     = $Pre_current_Status.Output
                                        "Launch_Time"       = $Pre_Launch_Time
                                        }
                                    }
                                    else
                                    {
                                        Write-Host "Failed to initiate reboot for $($KION.hosts)."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate reboot for $($KION.hosts)."
                                        $Pre_Failed += @("$($KION.hosts) `n")
                                    }
                                }
                                elseif($Pre_current_Status.Output -like "*stopped*")
                                {
                                    
                                    $Pre_Launch_Time = "NA"
                                    Write-Host "Uptime of $($host[$i]) is $Pre_Launch_Time"
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($host[$i]) is $Pre_Launch_Time"

                                    Write-Host "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Proceeding to start the server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Proceeding to start the server."
                                    $Already_Stopped += @("$($KION.hosts) `n")
                                    $reboot_stopped = Invoke-SSHCommand -SessionId $session -Command "aws ec2 start-instances --instance-ids $($KION.insids) --output text --query 'StartingInstances[*].CurrentState.Name'"
                                    #Invoke-SSHCommand -SessionId $session -Command "turbot-aws -a $($KION.account) --role-name=admin  ec2 start-instances --instance-ids $($KION.insids) --region $($KION.av_zone) --output text --query 'StartingInstances[*].CurrentState.Name'"
                                    if(($reboot_stopped.ExitStatus -eq 0) -and ($reboot_stopped.Output -like "*pending*"))
                                    {
                                        Write-Host "$($KION.hosts) start initiated."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "$($KION.hosts) start initiated."
                                        $initiate_Start += @("$($KION.hosts) `n")
                                        $Success_server_info  += [PSCustomObject] @{     
                                        "HostName"          = $KION.hosts       
                                        "Instance_ID"       = $KION.insids         
                                        "Availability_Zone" = $KION.av_zone     
                                        "Account"           = $KION.account     
                                        "OS"                = $os      
                                        "Environment"       = $KION.Environment 
                                        "IP_Address"        = $KION.IP_address
                                        "Current_State"     = $Pre_current_Status.Output
                                        "Launch_Time"       = $Pre_Launch_Time
                                        }
                                    }
                                    else
                                    {
                                        Write-Host "Failed to initiate start for $($KION.hosts)."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate start for $($KION.hosts)."
                                        $Pre_Failed += @("$($KION.hosts) `n")
                                    }
                                }
                                else
                                {
                                    Write-Host "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Skipping and proceeding to the next server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Skipping and proceeding to the next server."
                                    $Not_Stopped += @("$($KION.hosts)")
                                }
                                $current_Pre_Status += @("$($KION.hosts) - $current_Status `n")
								$current_Pre_Status
                            }
                            else
                            {
                                Write-Host "Failed to initiate reboot for $($KION.hosts)."
                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate reboot for $($KION.hosts)."
                                $Pre_Failed += @("$($KION.hosts) `n")
                            }
                        }
                        else
                        {
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Pre Failed for $($KION.hosts)."
                            $Pre_Failed += @("$($KION.hosts) `n")
                        }
                    }
                    else
                    {
                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Pre Failed for $($KION.hosts)."
                        $Pre_Failed += @("$($KION.hosts) `n")
                    }
                }
                else
                {
                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Pre Failed for $($KION.hosts)."
                    $Pre_Failed += @("$($KION.hosts) `n")
                }
            }
            else
            {
                Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Pre Failed for $($KION.hosts)."
                $Pre_Failed += @("$($KION.hosts) `n")
            }
        }
        catch
        {
            Write-Host "Pre Non Prod failed for $($KION.hosts)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Pre Non Prod failed"
            $Pre_Failed += @($KION.hosts)
        }
    }#NonProd over
    elseif($env -eq "P")
    {
        Write-Host "Prod env"
        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Prod Env"
        try
        {
            $keys = (Invoke-SSHCommand -SessionId $session -Command "kion --profile prod stak --l $($KION.account)  --car $Kion_user -p").Output
            $Access_key = (($keys -split "export AWS_ACCESS_KEY_ID=")[1]).Trim()
            $secret_key = (($keys -split "export AWS_SECRET_ACCESS_KEY=")[2]).Trim()
            $token_ID   = (($keys -split "export AWS_SESSION_TOKEN=")[3]).Trim()
            Write-Host "AWS_ACCESS_KEY_ID $Access_key"
            Write-Host "AWS_SECRET_ACCESS_KEY $secret_key"
            Write-Host "AWS_SESSION_TOKEN $token_ID"

            Write-Host "Setting up environment for $($KION.av_zone)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Setting up environment for $($KION.av_zone)"

            $Set_Access_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_access_key_id $Access_key"
            if($Set_Access_key.ExitStatus -eq "0")
            {
                $Set_Secret_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_secret_access_key $secret_key"
                if($Set_Secret_key.ExitStatus -eq "0")
                {
                    $Set_Session_token = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_session_token $token_ID"
                    if($Set_Session_token.ExitStatus -eq "0")
                    {
                        $Set_Region = Invoke-SSHCommand -SessionId $session -Command "aws configure set region $($KION.av_zone)"
                        if($Set_Region.ExitStatus -eq "0")
                        {
                                
                            Write-Host "Environment setup successfully for $($KION.account)"
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value  "Environment setup successfully for $($KION.av_zone)"
                            $Pre_current_Status = Invoke-SSHCommand -SessionId $session -Command "aws ec2 describe-instances --instance-ids $($KION.insids) --output text --query 'Reservations[*].Instances[*].State.Name'"
						    $Pre_current_Status
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current State of $($KION.hosts) is $($Pre_current_Status.Output) ExitStatus is $($Pre_current_Status.ExitStatus)"
                            if($Pre_current_Status.ExitStatus -eq "0") 
                            {   
                                $current_Status = $Pre_current_Status.Output
                                if($Pre_current_Status.Output -like "*running*")
                                {
                                    if($os -contains "Windows")
                                    {
                                        try
                                        {
                                            $Error.Clear()
                                            $Pre_Launch_Time = Invoke-Command -ComputerName $($KION.hosts) -Credential $cred -ScriptBlock {(gcim Win32_OperatingSystem). LastBootUpTime}
                                            if($Error)
                                            {
                                                $Pre_Launch_Time = "NA"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value $Error.errordetails.Message
                                            }
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                        catch
                                        {
                                            $Pre_Launch_Time = "NA"
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                    }
                                    elseif($os -contains "LINUX")
                                    {
                                        try
                                        {
                                            #Write-Host "New-SSHSession -ComputerName $($KION.IP_address) -Credential $credsss"
                                            $host_session = New-SSHSession -ComputerName $($KION.IP_address) -Credential $credsss -AcceptKey -Force 
                                            #Write-Host "Host session is $host_session"
                                            $host_Session_ID = $host_session.SessionId
                                            $Pre_Launch_Time = Invoke-SSHCommand -SessionId $host_Session_ID -Command "uptime -s"

                                            if($Pre_Launch_Time.ExitStatus -eq "0")
                                            {
                                                Write-Host "Uptime of $($KION.hosts) is $($Pre_Launch_Time.Output)"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $($Pre_Launch_Time.Output)"
                                            }
                                            else
                                            {
                                                $Pre_Launch_Time = "NA"
                                                Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            }
                                            Remove-SSHSession -SessionId $host_session_ID
                                        }
                                        catch
                                        {
                                            $Pre_Launch_Time = "NA"
                                            Write-Host "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($KION.hosts) is $Pre_Launch_Time"
                                        }
                                    }

                                    Write-Host "Current Status of $($KION.hosts) is Running. Proceeding to Reboot the server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is Running. Proceeding to Reboot the server."
                                    $Pre_Running += @("$($KION.hosts)")
									$reboot_running = Invoke-SSHCommand -SessionId $session -Command "aws ec2 reboot-instances --instance-ids $($KION.insids) --region $($KION.av_zone)"
                                    $reboot_running 

                                    if($reboot_running.ExitStatus -eq 0)
                                    {
                                        Write-Host "$($KION.hosts) reboot initiated."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "$($KION.hosts) reboot initiated."
                                        $initiate_reboot  += @("$($KION.hosts) `n")
                                        
                                        $Success_server_info  += [PSCustomObject] @{     
                                        "HostName"          = $KION.hosts       
                                        "Instance_ID"       = $KION.insids         
                                        "Availability_Zone" = $KION.av_zone     
                                        "Account"           = $KION.account     
                                        "OS"                = $os      
                                        "Environment"       = $KION.Environment 
                                        "IP_Address"        = $KION.IP_address
                                        "Current_State"     = $Pre_current_Status.Output
                                        "Launch_Time"       = $Pre_Launch_Time
                                        }
                                    }
                                    else
                                    {
                                        Write-Host "Failed to initiate reboot for $($KION.hosts)."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate reboot for $($KION.hosts)."
                                        $Pre_Failed += @("$($KION.hosts) `n")
                                    }
                                }
                                elseif($Pre_current_Status.Output -like "*stopped*")
                                {
                                    
                                    $Pre_Launch_Time = "NA"
                                    Write-Host "Uptime of $($host[$i]) is $Pre_Launch_Time"
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Uptime of $($host[$i]) is $Pre_Launch_Time"

                                    Write-Host "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Proceeding to start the server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Proceeding to start the server."
                                    $Already_Stopped += @("$($KION.hosts) `n")
                                    $reboot_stopped = Invoke-SSHCommand -SessionId $session -Command "aws ec2 start-instances --instance-ids $($KION.insids) --output text --query 'StartingInstances[*].CurrentState.Name'"
                                    #Invoke-SSHCommand -SessionId $session -Command "turbot-aws -a $($KION.account) --role-name=admin  ec2 start-instances --instance-ids $($KION.insids) --region $($KION.av_zone) --output text --query 'StartingInstances[*].CurrentState.Name'"
                                    if(($reboot_stopped.ExitStatus -eq 0) -and ($reboot_stopped.Output -like "*pending*"))
                                    {
                                        Write-Host "$($KION.hosts) start initiated."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "$($KION.hosts) start initiated."
                                        $initiate_Start += @("$($KION.hosts) `n")
                                        $Success_server_info  += [PSCustomObject] @{     
                                        "HostName"          = $KION.hosts       
                                        "Instance_ID"       = $KION.insids         
                                        "Availability_Zone" = $KION.av_zone     
                                        "Account"           = $KION.account     
                                        "OS"                = $os      
                                        "Environment"       = $KION.Environment 
                                        "IP_Address"        = $KION.IP_address
                                        "Current_State"     = $Pre_current_Status.Output
                                        "Launch_Time"       = $Pre_Launch_Time
                                        }
                                    }
                                    else
                                    {
                                        Write-Host "Failed to initiate start for $($KION.hosts)."
                                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate start for $($KION.hosts)."
                                        $Pre_Failed += @("$($KION.hosts) `n")
                                    }
                                }
                                else
                                {
                                    Write-Host "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Skipping and proceeding to the next server."
                                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "Current Status of $($KION.hosts) is $($Pre_current_Status.Output). Skipping and proceeding to the next server."
                                    $Not_Stopped += @("$($KION.hosts)")
                                }
                                $current_Pre_Status += @("$($KION.hosts) - $current_Status `n")
								$current_Pre_Status
                            }
                            else
                            {
                                Write-Host "Failed to initiate reboot for $($KION.hosts)."
                                Add-Content -Path "$path\Pre_log\Log.txt" -Value "Failed to initiate reboot for $($KION.hosts)."
                                $Pre_Failed += @("$($KION.hosts) `n")
                            }
                        }
                        else
                        {
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Pre Failed for $($KION.hosts)."
                            $Pre_Failed += @("$($KION.hosts) `n")
                        }
                    }
                    else
                    {
                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Pre Failed for $($KION.hosts)."
                        $Pre_Failed += @("$($KION.hosts) `n")
                    }
                }
                else
                {
                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Pre Failed for $($KION.hosts)."
                    $Pre_Failed += @("$($KION.hosts) `n")
                }
            }
            else
            {
                Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Pre Failed for $($KION.hosts)."
                $Pre_Failed += @("$($KION.hosts) `n")
            }
        }
        catch
        {
            Write-Host "Pre Non Prod failed for $($KION.hosts)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Pre Non Prod failed"
            $Pre_Failed += @($KION.hosts)
        }
    }
    else
    {
        Write-Host "Environment not defined for index value $i"
        $log += "Environment not defined for index value $i"
    }
}

Add-Content -Path "$path\Pre_log\Log.txt" -Value "Pre Execution Ends $(timestamp)"
Add-Content -Path "$path\Pre_log\Log.txt" -Value "-----------------"

Update-ticket -table $table -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Current Status of the servers are. `n `n $current_Pre_Status" 

###HERE
if($Pre_Failed)
{
    Update-ticket -table $table -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to get the status of below servers `n `n $Pre_Failed"
}
#######Here to be updated till here

Write-Host "Initiate sleep time 300"
start-sleep -Seconds 300

Add-Content -Path "$path\Post_log\Log.txt" -Value "-----------------"
Add-Content -Path "$path\Post_log\Log.txt" -Value "Script Execution Started at $(timestamp)"
Add-Content -Path "$path\Post_log\Log.txt" -Value "Service Account used for execution is Svc-ITPAM"

foreach($success_server_infos in $Success_server_info)
{
    $Post_Launch_Time = ""
    $Post_current_Status = ""

    Add-Content -Path "$path\Post_log\Log.txt" -Value "-----------------"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "Hostname: $($success_server_infos.HostName)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "Instance ID: $($success_server_infos.Instance_ID)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "Availability Zone: $($success_server_infos.Availability_Zone)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "AWS Account ID: $($success_server_infos.Account)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "OS: $($success_server_infos.OS)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "Environment: $($success_server_infos.Environment)"
    Add-Content -Path "$path\Post_log\Log.txt" -Value "IP Address: $($success_server_infos.IP_Address)"

    $post_Environment = $success_server_infos.Environment
    $post_Account = $success_server_infos.Account

    $env = $post_Environment[0]

    Write-Host "Env : $env"

    if($env -eq "N")
    {
        Write-Host "Non-prod env"
        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Non Prod Env"
        try
        {
            $keys = (Invoke-SSHCommand -SessionId $session -Command "kion --profile nonprod stak --l $($KION.account)  --car $Kion_user -p").Output
            $Access_key = (($keys -split "export AWS_ACCESS_KEY_ID=")[1]).Trim()
            $secret_key = (($keys -split "export AWS_SECRET_ACCESS_KEY=")[2]).Trim()
            $token_ID   = (($keys -split "export AWS_SESSION_TOKEN=")[3]).Trim()
            Write-Host "AWS_ACCESS_KEY_ID $Access_key"
            Write-Host "AWS_SECRET_ACCESS_KEY $secret_key"
            Write-Host "AWS_SESSION_TOKEN $token_ID"

            Write-Host "Setting up environment for $($KION.av_zone)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Setting up environment for $($KION.av_zone)"
            $Set_Access_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_access_key_id $Access_key"
            if($Set_Access_key.ExitStatus -eq "0")
            {
                $Set_Secret_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_secret_access_key $secret_key"
                if($Set_Secret_key.ExitStatus -eq "0")
                {
                    $Set_Session_token = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_session_token $token_ID"
                    if($Set_Session_token.ExitStatus -eq "0")
                    {
                        $Set_Region = Invoke-SSHCommand -SessionId $session -Command "aws configure set region $($KION.av_zone)"
                        if($Set_Region.ExitStatus -eq "0")
                        {
                            $Post_current_Status = Invoke-SSHCommand -SessionId $session -Command "aws ec2 describe-instances --instance-ids $($KION.insids) --output text --query 'Reservations[*].Instances[*].State.Name'"
                            #Invoke-SSHCommand -SessionId $session -Command "turbot-aws -a $($success_server_infos.Account) --role-name=admin  ec2 describe-instances --instance-ids $($success_server_infos.Instance_ID) --region $($success_server_infos.Availability_Zone) --output text --query 'Reservations[*].Instances[*].State.Name'"
                            $Post_current_Status
                        }
                        else
                        {
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Post Failed for $($KION.hosts)."
                            $Post_Failed += @("$($KION.hosts) `n")
                        }
                    }
                    else
                    {
                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Post Failed for $($KION.hosts)."
                        $Post_Failed += @("$($KION.hosts) `n")
                    }
                }
                else
                {
                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Post Failed for $($KION.hosts)."
                    $Post_Failed += @("$($KION.hosts) `n")
                }
            }
            else
            {
                Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Non-Prod Post Failed for $($KION.hosts)."
                $Post_Failed += @("$($KION.hosts) `n")
            }
        }
        Catch
        {
            Write-Host "Post Non Prod failed $($success_server_infos.HostName)"
            Add-Content -Path "$path\Post_log\Log.txt" -Value "KION Post failed"
            $Post_Failed += @($success_server_infos.HostName)
        }
    }#NovProd
    elseif($env -eq "P")
    {
        Write-Host "Prod env"
        Add-Content -Path "$path\Pre_log\Log.txt" -Value "Prod Env"
        try
        {
            $keys = (Invoke-SSHCommand -SessionId $session -Command "kion --profile prod stak --l $($KION.account)  --car $Kion_user -p").Output
            $Access_key = (($keys -split "export AWS_ACCESS_KEY_ID=")[1]).Trim()
            $secret_key = (($keys -split "export AWS_SECRET_ACCESS_KEY=")[2]).Trim()
            $token_ID   = (($keys -split "export AWS_SESSION_TOKEN=")[3]).Trim()
            Write-Host "AWS_ACCESS_KEY_ID $Access_key"
            Write-Host "AWS_SECRET_ACCESS_KEY $secret_key"
            Write-Host "AWS_SESSION_TOKEN $token_ID"

            Write-Host "Setting up environment for $($KION.av_zone)"
            Add-Content -Path "$path\Pre_log\Log.txt" -Value "Setting up environment for $($KION.av_zone)"
            $Set_Access_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_access_key_id $Access_key"
            if($Set_Access_key.ExitStatus -eq "0")
            {
                $Set_Secret_key = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_secret_access_key $secret_key"
                if($Set_Secret_key.ExitStatus -eq "0")
                {
                    $Set_Session_token = Invoke-SSHCommand -SessionId $session -Command "aws configure set aws_session_token $token_ID"
                    if($Set_Session_token.ExitStatus -eq "0")
                    {
                        $Set_Region = Invoke-SSHCommand -SessionId $session -Command "aws configure set region $($KION.av_zone)"
                        if($Set_Region.ExitStatus -eq "0")
                        {
                            $Post_current_Status = Invoke-SSHCommand -SessionId $session -Command "aws ec2 describe-instances --instance-ids $($KION.insids) --output text --query 'Reservations[*].Instances[*].State.Name'"
                            #Invoke-SSHCommand -SessionId $session -Command "turbot-aws -a $($success_server_infos.Account) --role-name=admin  ec2 describe-instances --instance-ids $($success_server_infos.Instance_ID) --region $($success_server_infos.Availability_Zone) --output text --query 'Reservations[*].Instances[*].State.Name'"
                            $Post_current_Status
                        }
                        else
                        {
                            Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Post Failed for $($KION.hosts)."
                            $Post_Failed += @("$($KION.hosts) `n")
                        }
                    }
                    else
                    {
                        Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Post Failed for $($KION.hosts)."
                        $Post_Failed += @("$($KION.hosts) `n")
                    }
                }
                else
                {
                    Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Post Failed for $($KION.hosts)."
                    $Post_Failed += @("$($KION.hosts) `n")
                }
            }
            else
            {
                Add-Content -Path "$path\Pre_log\Log.txt" -Value "KION Prod Post Failed for $($KION.hosts)."
                $Post_Failed += @("$($KION.hosts) `n")
            }
        }
        Catch
        {
            Write-Host "Post Non Prod failed $($success_server_infos.HostName)"
            Add-Content -Path "$path\Post_log\Log.txt" -Value "KION Post failed"
            $Post_Failed += @($success_server_infos.HostName)
        }
    }
    else
    {
        Write-Host "Else failed $($success_server_infos.HostName)"
        Add-Content -Path "$path\Post_log\Log.txt" -Value "Else failed"
        $Post_Failed += @($success_server_infos.HostName)
    }
    
    if($Post_current_Status.ExitStatus -eq "0")
    {
        $current_Status = $Post_current_Status.Output
        $current_Status
        if($Post_current_Status.Output -like "running")
        {
            if($os -contains "Windows")
            {
                try
                {
                    $Error.Clear()
                    $Post_Launch_Time = Invoke-Command -ComputerName $($success_server_infos.HostName) -Credential $cred -ScriptBlock {(gcim Win32_OperatingSystem). LastBootUpTime}
                    if($Error)
                    {
                        $Post_Launch_Time = "NA"
                        $Post_log += $Error.errordetails.Message
                    }
                    Write-Host "Uptime of $($success_server_infos.HostName) is $Post_Launch_Time"
                    Add-Content -Path "$path\Post_log\Log.txt" -Value  "Uptime of $($success_server_infos.HostName) is $Post_Launch_Time"
                }
                catch
                {
                    $Post_Launch_Time = "NA"
                    Write-Host "Uptime of $($success_server_infos.HostName) is $Post_Launch_Time"
                    Add-Content -Path "$path\Post_log\Log.txt" -Value "Uptime of $($success_server_infos.HostName) is $Post_Launch_TimePost_Launch_TimePost_Launch_Time"
                }
                    
            }
            elseif($os -contains "LINUX")
            {
                try
                {
                        
                    $host_session = New-SSHSession -ComputerName $($success_server_infos.IP_Address) -Credential $credsss -AcceptKey -Force
                    $host_Session_ID = $host_session.SessionId
                    $Post_Launch = Invoke-SSHCommand -SessionId $host_Session_ID -Command "uptime -s"
                    if($Post_Launch.ExitStatus -eq "0")
                    {
                        $Post_Launch_Time = $Post_Launch.Output
                        Remove-SSHSession -SessionId $host_session_ID
                        Write-Host "Uptime of $($success_server_infos.HostName) is $($Post_Launch_Time)"
                        Add-Content -Path "$path\Post_log\Log.txt" -Value "Uptime of $($success_server_infos.HostName) is $($Post_Launch_Time)"
                    }     
                }
                catch
                {
                    $Post_Launch_Time = "NA"
                    Write-Host "Uptime of $($success_server_infos.HostName) is $Post_Launch_Time"
                    Add-Content -Path "$path\Post_log\Log.txt" -Value  "Uptime of $($success_server_infos.HostName) is $Post_Launch_Time"
                }
            }

            Add-Content -Path "$path\Post_log\Log.txt" -Value "Current State of $($success_server_infos.HostName) is $($Post_current_Status.Output) Exit Status is $($Post_current_Status.ExitStatus)"
            Add-Content -Path "$path\Post_log\Log.txt" -Value "Launch TIme of $($success_server_infos.HostName) is $($Post_Launch_Time) Exit Status is $($Post_current_Status.ExitStatus))"

            if(($success_server_infos.Launch_Time -ne $($Post_Launch_Time)) -and ($Post_Launch_Time -ne "NA"))
            {
                if(Test-Connection -ComputerName $($success_server_infos.IP_Address) -Quiet)
                {
                    Add-Content -Path "$path\Post_log\Log.txt" -Value "Restart Success for $($success_server_infos.HostName)"
                    $Final_Success += @($success_server_infos.HostName)
                }
                else
                {
                    Add-Content -Path "$path\Post_log\Log.txt" -Value "Failed to get ping response $($success_server_infos.HostName)"
                    $Post_Failed += @($success_server_infos.HostName)
                }
            }
            else
            {
                    Add-Content -Path "$path\Post_log\Log.txt" -Value "Launch Time not changed $($success_server_infos.HostName)"
                    $Post_Failed += @($success_server_infos.HostName)
            }
        }
        else
        {
            Add-Content -Path "$path\Post_log\Log.txt" -Value "Not Running $($success_server_infos.HostName)"
            $Post_Failed += @($success_server_infos.HostName)
        }
        $current_Post_Status += @("$($success_server_infos.HostName) - $current_Status `n")
		$current_Post_Status
    }
    else
    {
        Add-Content -Path "$path\Post_log\Log.txt" -Value "Failed to get Post Status or the Post Launch Time for $($success_server_infos.HostName)"
        $Post_Failed += @($success_server_infos.HostName)
    }
}

Add-Content -Path "$path\Post_log\Log.txt" -Value "Script Execution Ends $(timestamp)"
Add-Content -Path "$path\Post_log\Log.txt" -Value "-----------------"

if($current_Post_Status)
{
    Update-ticket -table $table -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Current status of the servers are. `n `n $current_Post_Status"
}
if($Post_Failed)
{
    Update-ticket -table $table -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Failed to get the status of below server(s) `n `n $Post_Failed"
}
if($Final_Success)
{
    Update-ticket -table $table -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Below Server(s) are restarted Successfully. `n `n $Final_Success"
}

$success = $Final_Success.Count

if($success -eq $hostname_count)
{
    write-host "Success"
    try{Resolve-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "All the requested server(s) are restarted successfully. `n `n $Final_Success" -table $table}
    catch{Write-Host "Unable to Resolve ticket `n"}
    Exit
}
else
{
    write-host "Fail"
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Below Server(s) are restarted Successfully. `n `n $Final_Success `nFailed to restart the below server(s) `n `n$Post_Failed `nHence routing the ticket." -asign_grp $assign -table $table}
    catch{Write-Host "Failed to Route Ticket"; Exit}
    Exit
}

Post Execution:

if(Process.Ping_check.scriptOutput.indexOf("Ticket Resolved Successfully")>=0)
{
  Process.ReturnCode=1
  Process.ReturnMessage="Ticket Resolved Successfully. "

}
else if(Process.Ping_check.scriptOutput.indexOf("Assignment Group updated successfully")>=0)
{
  Process.ReturnCode=2
  Process.ReturnMessage="Assignment Group updated successfully. "
}
else
{
Process.ReturnCode=-1
Process.returnMessage = "Failed to Restart Servers"
}

7.Fatal Ticket Update

Pre Execution:

Process.OSType = Process.OS.toLowerCase();

if(Process.OSType.indexOf("windows") >= 0){
	Process.GroupSysId = "d32d41c5dbe73e00d41dd3cb5e96194f";
}
else if(Process.OSType.indexOf("linux") >= 0){
  	Process.GroupSysId = "5b2d41c5dbe73e00d41dd3cb5e961955";
}

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.FatalErrorPayLoad ="<request><entry><assignment_group>"+Process.GroupSysId+"</assignment_group><assigned_to></assigned_to><u_automation_result>Unsuccessful</u_automation_result><state>1</state><work_notes>"+Process.returnMessage+"Hence Routing the ticket.</work_notes></entry></request>"
