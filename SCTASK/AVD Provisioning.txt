1. Get Ticket

Pre Execution:

Process.url = "https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task?number="+Process.SCTASK_Number

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket details fetched successfully"
  Process.Output=Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Failure fetching ticket details"
}

2.Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('state')>=0)
  {Process.state=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active=='true')
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket updated successfully ";
  }
  else
  {
	Process.ReturnCode=2;
	Process.ReturnMessage="Error occurred while  updating ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while updating ticket."
}

4.Script

Inline:

####ITPAM

param(
$Number,
$snowkey,
$snowp,
$snowpa,
$SNOW_Env,
$User_name,
$Group_name_inp
)

$Number
$snowkey
#$snowp
#$snowpa
$SNOW_Env
$User_name
$Group_name_inp

$table = "sc_task"
$script_name = "AVD_Provisioning"
$log = @()
$path = "D:\$script_name\$Number"
$log_path = "$path\Logs"
$assign = "09a7d15787c6f55455b02026dabb3563" #AVD Support group
$snowpass = "$snowp"+"#%4"+$snowpa+"_"

#Creating File path for logs
$filePaths = "$path\Logs", "$path\Command_Output", "$path\Evidence"
foreach($filePath in $filePaths)
{
    If(!(test-path $filePath))
    {
          New-Item -ItemType Directory -Force -Path $filePath 
    }
}

If(!(test-path "$log_path\log.txt"))
{
    New-Item -ItemType File -Name "Log.txt" -Path $log_path
}

Add-Content -Path "$log_path\Log.txt" -Value "-----------------"
Add-Content -Path "$log_path\Log.txt" -Value "Service Account used for execution is Svc-linux-snow"

#Importing biogen module
Try
{
    Import-Module "D:\Wave 1 Scripts\Biogen_Module\Biogen_Module.psm1"
}
catch
{
	Write-Host "Failed to import module"
    Exit
}

function timestamp{
    Get-Date -Format "dd_MMM_yyyy_HH:mm:ss tt"
}

Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;

public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(ServicePoint srvPoint, X509Certificate certificate, WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy

#Fetching SYSID of the ticket
try
{
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $global:headers = @{"Authorization" = "Basic "+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($snowkey+":"+$snowpass))}

    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $get_inc = "https://$SNOW_Env.service-now.com/api/now/v2/table/$($table)?number=$Number"
    $inc_result = Invoke-WebRequest -Uri $get_inc -Headers $global:headers -Method Get -ContentType "application/json" -UseBasicParsing
    $incout = $inc_result | ConvertFrom-JSON
    $inc_sysid = $incout.result.sys_id
    $description = $incout.result.description
    $description
    $description
    $Group_name = ($description -split "Group: ")[1]
	$Group_name
}
catch
{
    Write-Host "Failed to fetch Ticket details"
    Add-Content -Path "$log_path\Log.txt" -Value "Failed to fetch Ticket details"
    Exit
}

Add-Content -Path "$log_path\Log.txt" -Value "Script Execution Started at $(timestamp)"

Try
{
    Update-Start -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table
    Add-Content -Path "$log_path\Log.txt" -Value "Updated Start"
}
catch
{
	Write-Host "Failed to update start"
    Add-Content -Path "$log_path\Log.txt" -Value "Failed to update start"
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass  -work_notes "Failed to update start" -table $table -asign_grp $assign}
    catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
    Exit
}

"Details fetched and calling the fast API for $User_name and group $Group_name"
Add-Content -Path "$log_path\Log.txt" -Value "Details fetched and calling the fast API for $User_name and group $Group_name"
#Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Details fetched and calling the fast API for $User_name and group $Group_name" -table $table -comments "Details fetched and calling the fast API for $User_name and group $Group_name"
Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "Details fetched for $User_name and group $Group_name, proceeding further"


$jsonObject = @{record_number = $Number
target_user = "$User_name"
AVD = "CN=$Group_name,OU=Groups,DC=corp,DC=biogen,DC=com"}
 
# Convert the PowerShell hashtable to JSON 
$jsonBody = $jsonObject | ConvertTo-Json

Add-Content -Path "$log_path\Log.txt" -Value "$jsonBody"

$Error.Clear()

# Make the POST request 
$response = Invoke-RestMethod -Uri 'https://avd.containers.biogen.com/avd/' -Method Post -Body $jsonBody -ContentType 'application/json'
$output  = $response | ConvertFrom-Json

write-host "Restmethod completed"

$output.log #Log from AVD itself 
$output.code
Add-Content -Path "$log_path\Log.txt" -Value "Log: `n $output.log"
Add-Content -Path "$log_path\Log.txt" -Value "Code: `n $output.code"

if(!($Error))
{
    Write-Host "Entererred if"
    Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "$($output.log)"

    if(($output.code) -eq 200)
    {
		write-host "Success, will wait for 30mins"
        Add-Content -Path "$log_path\Log.txt" -Value "Success, will wait for 30mins"  
        start-sleep -Seconds 1800
	    write-host "Successfully added user to the group - Return code $($output.code)"
        Add-Content -Path "$log_path\Log.txt" -Value "Successful"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "Successfully added user $User_name to the group"
        try{Resolve-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -close_notes "User added Successfully to the group" -work_notes "Successfully added user $User_name to the group" -table $table}
        catch{Add-Content -Path "$log_path\Log.txt" -Value "Unable to update ticket `n"; Write-Host "Failed to Route Ticket"; Exit}
        Exit
    }
    elseif((($output.code) -eq 400) -and ($($output.log) -match "does not exist"))
    {
        write-host "User does not exist - Return code $($output.code)"
        Add-Content -Path "$log_path\Log.txt" -Value "User does not exist - Return code $($output.code)"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "User $User_name does not exist. Hence routing the ticket."
        #try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "User $User_name does not exist. Hence routing the ticket." -asign_grp $assign -table $table}
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -asign_grp $assign -table $table}
        catch{Add-Content -Path "$log_path\Log.txt" -Value "Unable to update ticket `n"; Write-Host "Failed to Route Ticket"; Exit}
        Exit
    }
    elseif((($output.code) -eq 400) -and ($($output.log) -match "already is assigned"))
    {
        write-host "User already assigned to the group - Return code $($output.code)"
        Add-Content -Path "$log_path\Log.txt" -Value "User already assigned to the group - Return code $($output.code)"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "User $User_name already assigned to the group. Hence routing the ticket."
        #try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "User $User_name already assigned to the group. Hence routing the ticket." -asign_grp $assign -table $table}
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -asign_grp $assign -table $table}
        catch{Add-Content -Path "$log_path\Log.txt" -Value "Unable to update ticket `n"; Write-Host "Failed to Route Ticket"; Exit}
        Exit
    }
    else
    {
        write-host "Unknown - Return code $($output.code)"
        Add-Content -Path "$log_path\Log.txt" -Value "Unknown - Return code $($output.code)"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "Unable to add the user $User_name. Hence routing the ticket."
        #try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to add the user $User_name. Hence routing the ticket." -asign_grp $assign -table $table}
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass  -asign_grp $assign -table $table}
        catch{Add-Content -Path "$log_path\Log.txt" -Value "Unable to update ticket `n"; Write-Host "Failed to Route Ticket"; Exit}
        Exit
    }
}
else
{
    Write-Host "$Error"
    Add-Content -Path "$log_path\Log.txt" -Value "$Error"
    Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -table $table -comments "Some error occurred. Hence routing the ticket."
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -asign_grp $assign -table $table}
    catch{Add-Content -Path "$log_path\Log.txt" -Value "Unable to update ticket `n"; Write-Host "Failed to Route Ticket"; Exit}
}

Post Execution:

if(Process.Ping_check.scriptOutput.indexOf("Ticket Resolved Successfully")>=0)
{
  Process.ReturnCode=1
  Process.ReturnMessage="Ticket Resolved Successfully. "
}
else if(Process.Ping_check.scriptOutput.indexOf("Assignment Group updated successfully")>=0)
{
  Process.ReturnCode=1
  Process.ReturnMessage="Assignment Group updated successfully"
}
else
{
Process.ReturnCode=3
Process.returnMessage = "Failed to perform the activity"
}

5. Fatal Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.FatalErrorPayLoad ="<request><entry><u_automation_result>Unsuccessful</u_automation_result><state>1</state><work_notes>"+Process.returnMessage+"Hence Routing the ticket.</work_notes></entry></request>"
