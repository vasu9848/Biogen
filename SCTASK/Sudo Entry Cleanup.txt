1. Get Ticket

Pre Execution:

Process.url = "https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task?number="+Process.Number

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket details fetched successfully"
  Process.Output=Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Failure fetching ticket details"
}

2.Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('state')>=0)
  {Process.state=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active=='true')
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket updated successfully ";
  }
  else
  {
	Process.ReturnCode=2;
	Process.ReturnMessage="Error occurred while  updating ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while updating ticket."
}

4.Script

Inline:

Param(
$Number,
$username,
$pass,
$snowkey,
$snowp,
$snowpa,
$SNOW_Env,
$user,
$SSHpass)

Import-Module "D:\Wave 1 Scripts\Biogen_Module\Biogen_Module.psm1"

$snowpass = "$snowp"+"#%4"+$snowpa+"_"

$table = "sc_task"
$log = @()
$success, $failed, $success_servers = @()
$script_name = "Sudo_entry_Cleanup"
$username = "svc-linux-snow"
$keyfile  = "D:\ITPAM\ssh.key"
$UNIX = "5b2d41c5dbe73e00d41dd3cb5e961955"
$evidence_path = "\\usawsgabb0082\Linux_Prod\sudo\$Number"
$ansible_server = "rtpinojump1"
$password = "$SSHpass" +"%"

$path = "D:\LINUX\$script_name\$Number"
$log_path = "$path\Logs"
$pre_html = "$path\Evidence\pre_sudoer.txt"
$post_html = "$path\Evidence\post_sudoer.txt"

$pwd = $password | ConvertTo-SecureString -AsPlainText -Force
$cred = New-Object pscredential -ArgumentList ($username , $pwd)

try
{
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $global:headers = @{"Authorization" = "Basic "+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($snowkey+":"+$snowpass))}

    $get_inc = "https://$SNOW_Env.service-now.com/api/now/v2/table/sc_task?number=$Number"
    $inc_result = Invoke-WebRequest -Uri $get_inc -Headers $global:headers -Method Get -ContentType "application/json" -UseBasicParsing
    $incout = $inc_result | ConvertFrom-JSON
    $inc_sysid = $incout.result.sys_id
    $description = $incout.result.description
}
catch
{
    Write-Host "Failed to fetch Ticket details"
    $log += "Failed to fetch Ticket details `n"
    Exit
}

$filePaths = "$path\logs", "$path\Command_Output", "$path\Evidence"
foreach($filePath in $filePaths)
{
    If(!(test-path $filePath))
    {
          New-Item -ItemType Directory -Force -Path $filePath 
    }
}

$log += "----------------- `n"
$log += "Script Execution Started at $(timestamp)`n"
$log += "Service Account used for execution is Svc-linux-snow`n"



Write-Host "Sudo Entry cleanup for users $user" -ForegroundColor Green
$log += "Sudo Entry cleanup for users $user`n" 
Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Sudo Entry cleanup for user $user" -table "sc_task"
try
{
    New-SSHSession -ComputerName $ansible_server -Credential $cred #-Keyfile $keyfile -AcceptKey
    $session = (Get-SSHSession).SessionId
    Write-Host "Session Established Successfully with $ansible_server" -ForegroundColor Green   
    $Logs += "Session Established Successfully with $ansible_server `n"
    Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Session Established and running Sudo entry cleanup" -table "sc_task"
}
catch
{
    Write-Host "Failed to establish connection with $ansible_server"
    $log += "Failed to establish connection with $ansible_server `n"
    End-log -logcontent $log -logpath $log_path
    try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to establish connection with $ansible_server" -table "sc_task" -asign_grp $unix}
    catch{Write-Host "Failed to Route Ticket"; Exit}
    Exit
}



#$command = Invoke-SSHCommand -SessionId $session -Command "ansible-playbook /home/svc-linux-snow/sentry/main.yml -e 'user_name=$user scn=$number ansible_user=$username ansible_password=$password'"
$command = Invoke-SSHCommand -SessionId $session -Command "ansible-playbook /tools/etc/iautomate_bkp/main.yml -e 'user_name=$user scn=$number ansible_user=$username ansible_password=$password'"
$command.Output | Out-File -FilePath "$path\Command_output\sudo_cleanup.txt"


if(($command.Exitstatus -eq 0) -or ($command.Exitstatus -eq 2))# -and ($command.output -match "successfull"))
{
    foreach ($line in $command.Output)
    {
        $count++
        #Write-Host $line

        if($line -match "Failed to backup sudoers file")
        {
            write-Host "Failed to backup sudoers file"
            $Log += "Failed to backup sudoers file"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to backup sudoers file" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }

        if($line -match "Failed to backup to the remote server of pre sudoers file")
        {
            write-Host "Failed to backup to the remote server of pre sudoers file"
            $Log += "Failed to backup to the remote server of pre sudoers file"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to backup to the remote server of pre sudoers file" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }

        if($line -match "Pre Sudoers file failed to backed up to")
        {
            write-Host "Pre Sudoers file failed to backed up to"
            $Log += "Pre Sudoers file failed to backed up to"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Pre Sudoers file failed to backed up to" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        
        if($line -match "Username not available in the sudoers file")
        {
            write-Host "Username not available in the sudoers file"
            $Log += "Username not available in the sudoers file"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Username not available in the sudoers file" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        
        if($line -match "Post Sudoers file failed to backed up to")
        {
            write-Host "Post Sudoers file failed to backed up to"
            $Log += "Post Sudoers file failed to backed up to"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Post Sudoers file failed to backed up to" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }

        if($line -match "Total Count of target servers to push :")
        {
            $Overallserver_count = (($line -split '"msg": "Total Count of target servers to push :') -split '"').trim() | ?{$_ -ne ""}
            #Write-Host $Overallserver_count
        }
        if($line -match "Total server names :")
        {
           $Server = (($line -split '"msg": "Total server names : ') -split ']"')
           $Overallserver = (((($Server.Replace("[","")).replace("u'","")).replace("'","")).split(",")).trim() | ?{$_ -ne ""}
           #Write-Host $Overallserver       
        }
        #Fully failed scenerio
        if($line -match "failed to push all servers count :")
        {
            $Failedserver_count = (($line -split '"failed to push all servers count : ') -split '",').trim() | ?{$_ -ne ""}
            #Write-Host $Failedserver_count
            $failed = 1
        }
        if($line -match "failed server names :")
        {
           $Server = (($line -split '"failed server names :') -split ']",')
           $Failedserver = (((($Server.Replace("[","")).replace("u'","")).replace("'","")).split(",")).trim() | ?{$_ -ne ""}
           #Write-Host $Failedserver       
        }
        #Fully Successful Scenerio
        if($line -match "successfully pushed all servers count :")
        {
            $Successserver_count = (($line -split '"successfully pushed all servers count : ') -split '",').trim() | ?{$_ -ne ""}
            #Write-Host $Successserver_count
            $success = 1
        }
        if($line -match "success server names :")
        {
           $Server = (($line -split '"success server names :') -split ']",')
           $Successserver = (((($Server.Replace("[","")).replace("u'","")).replace("'","")).split(",")).trim() | ?{$_ -ne ""}
           #Write-Host $Successserver       
        }
        #partially failed and partially sucess scenerio
        if($line -match "Failed servers count :")
        {
            $Partially_Failedserver_count = (($line -split '"Failed servers count : ') -split '",').trim() | ?{$_ -ne ""}
            #Write-Host $Partially_Failedserver_count
        }
        if($line -match "failed to push servers :")
        {
           $Server = (($line -split '"failed to push servers : ') -split ']",')
           $Partially_Failedserver = (((($Server.Replace("[","")).replace("u'","")).replace("'","")).split(",")).trim() | ?{$_ -ne ""}
           #Write-Host $Partially_Failedserver       
        }
        if($line -match "success servers count :")
        {
            $Partially_Successserver_count = (($line -split '"success servers count : ') -split '",').trim() | ?{$_ -ne ""}
            #Write-Host $Partially_Successserver_count
        }
        if($line -match "successfully pushed servers :")
        {
           $Server = (($line -split '"successfully pushed servers : ') -split ']",')
           $Partially_Successserver = (((($Server.Replace("[","")).replace("u'","")).replace("'","")).split(",")).trim() | ?{$_ -ne ""}
           #Write-Host $Partially_Successserver       
        }
    }
    $Successserver_print, $Failedserver_print, $Partially_Successserver_print, $Partially_Failedserver_print = $null
    $Successserver | ForEach-Object{$Successserver_Print += "`n$_"}
    $Failedserver | ForEach-Object{$Failedserver_Print += "`n$_"}
    $Partially_Successserver | ForEach-Object{$Partially_Successserver_Print += "`n$_"}
    $Partially_Failedserver | ForEach-Object{$Partially_Failedserver_Print += "`n$_"}
    if(($success -eq 1) -and ($Overallserver_count -eq $Successserver_count))
    {
        $Log+= "`nSudo entry cleanup successfull for all $Successserver_count server(s) `n$Successserver_print"
        Write-Host "`nSudo entry cleanup successfull for all $Successserver_count server(s) `n$Successserver_print"
        #Uploading pre evidence
        try
        {
            Copy-Item -Path "$evidence_path\pre_sudoer.txt" -Destination "$path\Evidence"
            $log += "Copied Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Copy Pre Attachment"
            $Log += "Failed to Copy Pre Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Pre Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        $pre_html      = Get-ChildItem -Path $pre_html
        $pre_FullName  = $pre_html.FullName               
        $pre_Name      = $pre_html.Name
        try
        {
            Set-ItemProperty $pre_FullName -name IsReadOnly -value $false
            #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
            Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $pre_Name -pre_FullName $pre_FullName -table $table
            $log += "Uploaded Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Upload Pre Attachment"
            $Log += "Failed to Upload Pre Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Pre Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }

        #Uploading post evidence
        try
        {
            Copy-Item -Path "$evidence_path\post_sudoer.txt" -Destination "$path\Evidence"
            $log += "Copied Post Attachement"
        }
        catch
        {
            write-Host "Failed to Copy Post Attachment"
            $Log += "Failed to Copy Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        $post_html      = Get-ChildItem -Path $post_html
        $post_FullName  = $post_html.FullName               
        $post_Name      = $post_html.Name
        try
        {
            Set-ItemProperty $post_FullName -name IsReadOnly -value $false
            #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
            Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $post_Name -pre_FullName $post_FullName -table $table
            $log += "Uploaded Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Upload Post Attachment"
            $Log += "Failed to Upload Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        try{Resolve-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Sudo entry cleanup successfull for all $Successserver_count server(s) $Successserver_print" -table "sc_task"}
        catch{$Log += "Unable to update ticket `n"}
        End-log -logcontent $log -logpath $log_path
        Exit

    }
    elseif(($failed -eq 1) -and ($Overallserver_count -eq $Failedserver_count))
    {
        $Log+= "`nSudo entry cleanup failed for all $Failedserver_count server(s) `n$Failedserver_print"
        Write-Host "`nSudo entry cleanup failed for all $Failedserver_count server(s) `n$Failedserver_print"
        #Route-Ticket -number $number -script_name $script_name "Sudo entry cleanup failed for all the servers $Failedserver"
        #Uploading pre evidence
        try
        {
            Copy-Item -Path "$evidence_path\pre_sudoer.txt" -Destination "$path\Evidence"
            $log += "Copied Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Copy Pre Attachment"
            $Log += "Failed to Copy Pre Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Pre Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        $pre_html      = Get-ChildItem -Path $pre_html
        $pre_FullName  = $pre_html.FullName               
        $pre_Name      = $pre_html.Name
        try
        {
            Set-ItemProperty $pre_FullName -name IsReadOnly -value $false
            #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
            Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $pre_Name -pre_FullName $pre_FullName -table $table
            $log += "Uploaded Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Upload Pre Attachment"
            $Log += "Failed to Upload Pre Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Pre Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }

        #Uploading post evidence
        if(Get-ChildItem -Path "$evidence_path\post_sudoer.txt")
        {
            try
            {
                Copy-Item -Path "$evidence_path\post_sudoer.txt" -Destination "$path\Evidence"
                $log += "Copied Post Attachement"
            }
            catch
            {
                write-Host "Failed to Copy Post Attachment"
                $Log += "Failed to Copy Post Attachment"
                try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Post Attachment" -table $table -asign_grp $UNIX}
                catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
                End-log -logcontent $log -logpath $log_path
                Exit
            }
            $post_html      = Get-ChildItem -Path $post_html
            $post_FullName  = $post_html.FullName               
            $post_Name      = $post_html.Name
            try
            {
                Set-ItemProperty $post_FullName -name IsReadOnly -value $false
                #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
                Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $post_Name -pre_FullName $post_FullName -table $table
                $log += "Uploaded Pre Attachement"
            }
            catch
            {
                write-Host "Failed to Upload Post Attachment"
                $Log += "Failed to Upload Post Attachment"
                try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Post Attachment" -table $table -asign_grp $UNIX}
                catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
                End-log -logcontent $log -logpath $log_path
                Exit
            }
        }

        try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Sudo entry cleanup failed for all $Failedserver_count server(s) $Failedserver_print" -table "sc_task" -asign_grp $unix}
        catch{$Log += "Unable to update ticket `n"}
        End-log -logcontent $log -logpath $log_path
        Exit
    }
    else
    {
        $Log+= "`nSudo entry cleanup Successful for $Partially_Successserver_count server(s) `n$Partially_Successserver_print"
        Write-Host "`nSudo entry cleanup Successful for $Partially_Successserver_count server(s) `n$Partially_Successserver_print"
        $Log+= "`nSudo entry cleanup failed for $Partially_Failedserver_count server(s) `n$Partially_Failedserver_print"
        Write-Host "`nSudo entry cleanup failed for $Partially_Failedserver_count server(s) `n$Partially_Failedserver_print"
        #Route-Ticket -number $number -script_name $script_name
        try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Sudo entry cleanup Successful for $Partially_Successserver_count server(s) $Partially_Successserver_print `n`nand Failed for $Partially_Failedserver_count server(s) $Partially_Failedserver_print" -table "sc_task" -asign_grp $unix}
        catch{$Log += "Unable to update ticket `n"}
        End-log -logcontent $log -logpath $log_path
        Exit
    }
}
elseif(($command.Exitstatus -ne 0) -and ($command.output -match "failed=1"))
{
    #Uploading pre evidence
    try
    {
        Copy-Item -Path "$evidence_path\pre_sudoer.txt" -Destination "$path\Evidence"
        $log += "Copied Pre Attachement"
    }
    catch
    {
        write-Host "Failed to Copy Pre Attachment"
        $Log += "Failed to Copy Pre Attachment"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Pre Attachment" -table $table -asign_grp $UNIX}
        catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
        End-log -logcontent $log -logpath $log_path
        Exit
    }
    $pre_html      = Get-ChildItem -Path $pre_html
    $pre_FullName  = $pre_html.FullName               
    $pre_Name      = $pre_html.Name
    try
    {
        Set-ItemProperty $pre_FullName -name IsReadOnly -value $false
        #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
        Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $pre_Name -pre_FullName $pre_FullName -table $table
        $log += "Uploaded Pre Attachement"
    }
    catch
    {
        write-Host "Failed to Upload Pre Attachment"
        $Log += "Failed to Upload Pre Attachment"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Pre Attachment" -table $table -asign_grp $UNIX}
        catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
        End-log -logcontent $log -logpath $log_path
        Exit
    }

    #Uploading post evidence
    if(Get-ChildItem -Path "$evidence_path\post_sudoer.txt")
    {
        try
        {
            Copy-Item -Path "$evidence_path\post_sudoer.txt" -Destination "$path\Evidence"
            $log += "Copied Post Attachement"
        }
        catch
        {
            write-Host "Failed to Copy Post Attachment"
            $Log += "Failed to Copy Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        $post_html      = Get-ChildItem -Path $post_html
        $post_FullName  = $post_html.FullName               
        $post_Name      = $post_html.Name
        try
        {
            Set-ItemProperty $post_FullName -name IsReadOnly -value $false
            #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
            Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $post_Name -pre_FullName $post_FullName -table $table
            $log += "Uploaded Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Upload Post Attachment"
            $Log += "Failed to Upload Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
    }
    Write-Host "Sudo Entry cleanup failed for user $user"
    $Log += "Sudo Entry cleanup for failed user $user `n"
    try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Sudo Entry cleanup failed for user $user" -table "sc_task" -asign_grp $unix}
    catch{$Log += "Unable to update ticket `n"}
    End-log -logcontent $log -logpath $log_path
    Exit
}
else
{
    #Uploading pre evidence
    try
    {
        Copy-Item -Path "$evidence_path\pre_sudoer.txt" -Destination "$path\Evidence"
        $log += "Copied Pre Attachement"
    }
    catch
    {
        write-Host "Failed to Copy Pre Attachment"
        $Log += "Failed to Copy Pre Attachment"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Pre Attachment" -table $table -asign_grp $UNIX}
        catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
        End-log -logcontent $log -logpath $log_path
        Exit
    }
    $pre_html      = Get-ChildItem -Path $pre_html
    $pre_FullName  = $pre_html.FullName               
    $pre_Name      = $pre_html.Name
    try
    {
        Set-ItemProperty $pre_FullName -name IsReadOnly -value $false
        #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
        Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $pre_Name -pre_FullName $pre_FullName -table $table
        $log += "Uploaded Pre Attachement"
    }
    catch
    {
        write-Host "Failed to Upload Pre Attachment"
        $Log += "Failed to Upload Pre Attachment"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Pre Attachment" -table $table -asign_grp $UNIX}
        catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
        End-log -logcontent $log -logpath $log_path
        Exit
    }

    #Uploading post evidence
    if(Get-ChildItem -Path "$evidence_path\post_sudoer.txt")
    {
        try
        {
            Copy-Item -Path "$evidence_path\post_sudoer.txt" -Destination "$path\Evidence"
            $log += "Copied Post Attachement"
        }
        catch
        {
            write-Host "Failed to Copy Post Attachment"
            $Log += "Failed to Copy Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Copy Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
        $post_html      = Get-ChildItem -Path $post_html
        $post_FullName  = $post_html.FullName               
        $post_Name      = $post_html.Name
        try
        {
            Set-ItemProperty $post_FullName -name IsReadOnly -value $false
            #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Uploading pre evidence" -table $table
            Upload-PreAttachment -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -pre_Name $post_Name -pre_FullName $post_FullName -table $table
            $log += "Uploaded Pre Attachement"
        }
        catch
        {
            write-Host "Failed to Upload Post Attachment"
            $Log += "Failed to Upload Post Attachment"
            try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to Upload Post Attachment" -table $table -asign_grp $UNIX}
            catch{Write-Host "Failed to Route Ticket"; End-log -logcontent $log -logpath $log_path; Exit}
            End-log -logcontent $log -logpath $log_path
            Exit
        }
    }

    Write-Host "Sudo Entry cleanup failed for user $user"
    $Log += "Sudo Entry cleanup for failed user $user `n"
    try{Route-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Sudo Entry cleanup failed for user $user" -table "sc_task" -asign_grp $unix}
    catch{$Log += "Unable to update ticket `n"}
    End-log -logcontent $log -logpath $log_path
    Exit
}

Post Execution:

if(Process.Ping_check.scriptOutput.indexOf("Ticket Resolved Successfully")>=0)
{
  Process.ReturnCode=1
  Process.ReturnMessage="Ticket Resolved Successfully. "
}
else if(Process.Ping_check.scriptOutput.indexOf("Assignment Group updated successfully")>=0)
{
  Process.ReturnCode=2
  Process.ReturnMessage="Assignment Group updated successfully. "
}
else
{
Process.ReturnCode=-1
Process.returnMessage = "Failed to update sudoers file. "
}

5. Fatal Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.FatalErrorPayLoad ="<request><entry><u_automation_result>Unsuccessful</u_automation_result><state>1</state><work_notes>"+Process.returnMessage+"Hence Routing the ticket.</work_notes></entry></request>"


