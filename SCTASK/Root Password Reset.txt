1. Get Ticket

Pre Execution:

Process.url = "https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task?number="+Process.Number

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket details fetched successfully"
  Process.Output=Process[OpName].HTTPResponseContent
  
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Failure fetching ticket details"
}

2.Second Operator (Read)

Inline:

var str =Process.Output
var start=str.indexOf('[')+2;
var end=str.indexOf(']')-1;
var res = str.substring(start,end);
var out1= res.split(',');
for(var i=0;i < out1.length;i++)
{
  out1[i]=out1[i].replace(/\"/g,"");
  if(out1[i].indexOf('active')>=0)
  {Process.active=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('sys_id')>=0)
  {Process.Sys_Id=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('description')>=0)
  {Process.description=(out1[i].split(':'))[1]}
  else if(out1[i].indexOf('state')>=0)
  {Process.state=(out1[i].split(':'))[1]}
  out1[i]=(out1[i].split(':'))[1]
}

Post Execution:

if(Process.active=='true')
{
  Process.ReturnCode=0;
  Process.ReturnMessage="Ticket is active.";
}
else
{
  Process.ReturnCode=2;
  Process.ReturnMessage="Ticket is inactive.";
}

3.Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.payload = "<request><entry><assigned_to>d2f5f34bdb5efb8036c73c9b7c961900</assigned_to><work_notes>Automation Acknowledged. Ref ID:"+ Process.RuntimeROID+"</work_notes><state>2</state></entry></request>"

Post Execution:

if(Process[OpName].HTTPResponseReasonPhrase=="OK" && Process[OpName].HTTPResponseStatusCode==200 )
{
  if(Process[OpName].HTTPResponseContent.indexOf("state\":\"")>=0)
  {
	Process.ReturnCode=0;
	Process.ReturnMessage="Ticket updated successfully ";
  }
  else
  {
	Process.ReturnCode=2;
	Process.ReturnMessage="Error occurred while  updating ticket";
  }
}
else
{
  Process.ReturnCode=-1;
  Process.ReturnMessage="Failure occurred while updating ticket."
}

4.Script

Inline:

Param(
$Number,
$username,
$pass,
$snowkey,
$snowp,
$snowpa,
$SNOW_Env)


Import-Module "D:\Wave 1 Scripts\Biogen_Module\Biogen_Module.psm1"

$log = @()
$success, $failed, $success_servers = @()
$script_name = "Root_Password_Reset"
$Assignment_Group = "5b2d41c5dbe73e00d41dd3cb5e961955"

$keyfile  = "D:\ssh.key"
$password = $pass+"%"
$snowpass = "$snowp"+"#%4"+$snowpa+"_"
$pwd = $password | ConvertTo-SecureString -AsPlainText -Force
$cred = New-Object pscredential -ArgumentList ($username , $pwd)

$newpass = -Join("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&*%[]}{-)(@#$%1234567890".tochararray() | Get-Random -Count 16 | % {[char]$_})
$path = "D:\LINUX\Rootpassword_Reset\$Number"
$ansible_server = "10.240.151.74"

#Email parameters
$from = "automation@biogen.com"
$to = "mohan.mohta@biogen.com","DL-HclAutomation@biogen.com"
$cc = ""
$bcc = ""
$smtpserver = "smtp.biogen.com"

$filePaths = "$path\logs", "$path\Command_Output", "$path\Evidence"
foreach($filePath in $filePaths)
{
    If(!(test-path $filePath))
    {
          New-Item -ItemType Directory -Force -Path $filePath 
    }
}

$log += "----------------- `n"
$log += "Script Execution Started at $(timestamp)`n"
$log += "Service Account used for execution is Svc-linux-snow`n"

try
{
    [Net.ServicePointManager]::SecurityProtocol = "tls12, tls11, tls"
    $global:headers = @{"Authorization" = "Basic "+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($snowkey+":"+$snowpass))}

    $get_inc = "https://$SNOW_Env.service-now.com/api/now/v2/table/sc_task?number=$Number"
    $inc_result = Invoke-WebRequest -Uri $get_inc -Headers $global:headers -Method Get -ContentType "application/json" -UseBasicParsing
    $incout = $inc_result | ConvertFrom-JSON
    $inc_sysid = $incout.result.sys_id
    $description = $incout.result.description
}
catch
{
    Write-Host "Failed to fetch Ticket details"
    $log += "Failed to fetch Ticket details `n"
    Exit
}

#Splitting input paramaet to get server details
$servers = ($description -Split "Linux: Root Password Reset" |?{$_ -ne ""}).trim()
$servers = ($servers -Split "Server_IP_Addresses: " |?{$_ -ne " "}).trim()
$servers = ($servers -Split "," |?{$_ -ne ""}).trim()
$servers

Write-Host "Root password change for $($servers.count) servers" -ForegroundColor Green
$log += "Root password change for $($servers.count) servers `n"
Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Root password change for $($servers.count) server" -table "sc_task"
try
{
    New-SSHSession -ComputerName $ansible_server -Credential $cred -AcceptKey #-Keyfile $keyfile 
    $session = (Get-SSHSession).SessionId
    Write-Host "Session Established Successfully with $ansible_server" -ForegroundColor Green   
    $Logs += "Session Established Successfully with $ansible_server `n"
}
catch
{
    Write-Host "Failed to establish connection with $ansible_server"
    $log += "Failed to establish connection with $ansible_server `n"
    End-log -logcontent $log -logpath $log_path
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $Snow_env -apikey $snowkey -password $snowpass -work_notes "Failed to establish connection with $ansible_server" -table "sc_task" -asign_grp $Assignment_Group}
    catch{Write-Host "Failed to Route Ticket"; Exit}
    Exit
}

foreach($server in $servers)
{
    Write-host "Working for Server $server"
    $Log += "Working for Server $server `n"
    
    $command = Invoke-SSHCommand -SessionId $session -Command "ansible-playbook /home/svc-linux-snow/root_reset/root_change.yml -e 'target_server=$server new_pass=$newpass ansible_user=$username ansible_password=$password'"
    $command.Output | Out-File -FilePath clear
    $command.Output 
    if(($command.Exitstatus -eq 0) -and ($command.output -match "Root password changed successfully"))
    {
        Write-Host "Root user password update successful for $server" -ForegroundColor Green
        $Log += "Root user password update successful for $server `n"
        $success += @($server)
    }
    elseif(($command.Exitstatus -ne 0) -and ($command.output -match "failed=1"))
    {
        Write-Host "Root user password update failed for $server"
        $Log += "Root user password update failed for $server `n"
        $failed += @($server)
    }
    else
    {
        Write-Host "Root user password update unsuccessful for $server"
        $Log += "Root user password update unsuccessful for $server `n"
        $failed += @($server)
    }
}

<#Try to Login as root user
$Log += "Trying to login as Root user on all successful servers `n"
$root = "root"
$newpwd = $newpass | ConvertTo-SecureString -AsPlainText -Force
$newcred = New-Object pscredential -ArgumentList ($root , $newpwd)
foreach ($server in $success)
{
    Write-Host $server
    if(New-SSHSession -Computer $server -Credential $newcred -AcceptKey)
    {
        $success_servers += @($server)
    }
    else
    {
        $failed += @($server)
    }
}
##Logging all successful and unsuccessful servers#>
if($success -eq $null)
{
    Write-Host "Root user password not changed for any servers"
    $log += "Root user password not changed for any servers `n"    
    Update-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root user password not changed for any servers" -table "sc_task"
    try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root password reset unsuccessful. Hence routing the ticket." -table "sc_task" -asign_grp $Assignment_Group}
    catch{$log+= "Unable to update ticket `n"}
    End-log -logcontent $log -logpath "$path\Logs"
    Exit
}
elseif(($success.Count -eq $servers.Count))
{
    Write-Host "Root user password successfully changed for all the below servers: `n $success"
    $log += "Root user password successfully changed for all the below servers: `n $success"
    #Emailing root password
    try
    {
        $body = "New Root password set for the below servers is $newpass"
        $success | ForEach-Object{$body += "`n$_"}
        $subject = "New Root password"
            
        Send-MailMessage -To $to -From $from -Subject $subject -Body $body -SmtpServer $smtpserver
        $log+= "Root password shared on email"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root password shared on email" -table "sc_task"
    }
    catch
    {
        $log += "Unable to share root password on email `n"
        #Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to share root password on email"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to share root password on email" -table "sc_task" -asign_grp $Assignment_Group}
        catch{$log+= "Unable to update ticket `n"}
        End-log -logcontent $log -logpath "$path\Logs"
        Exit
    }
    Resolve-Ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root user password successfully changed for all the below servers: `n $success" -table "sc_task"
    End-log -logcontent $log -logpath "$path\Logs"
    Exit
}
else
{
    Write-Host "Root user password successfully changed for all the below servers: `n $success"
    Write-Host "Root user password change failed for all the below servers: `n $failed"
    $log += "Root user password successfully changed for all the below servers: `n $success`n"
    $log += "Root user password change failed for all the below servers: `n $failed `n"
    #Emailing root password
    try
    {
        $body = "New Root password set for the below servers is $newpass"
        $success | ForEach-Object{$body += "`n$_"}
        $smtpserver = "smtp.biogen.com"
        $subject = "New Root password"
            
        Send-MailMessage -To $to -From $from -Subject $subject -Body $body -SmtpServer $smtpserver
        $log+= "Root password shared on email `n"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root password shared on email" -table "sc_task"
    }
    catch
    {
        $log += "Unable to share root password on email `n"
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to share root password on email" -table "sc_task"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Unable to share root password on email" -table "sc_task" -asign_grp $Assignment_Group}
        catch{$log+= "Unable to update ticket `n"}
        End-log -logcontent $log -logpath "$path\Logs"
        Exit
    }
    try
    {
        Update-Ticket -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root user password successfully changed for the below servers: `n $success" -table "sc_task"
        try{Route-ticket -number $number -script_name $script_name -inc_sysid $inc_sysid -SNOW_Env $SNOW_Env -apikey $snowkey -password $snowpass -work_notes "Root user password change failed for the below servers: `n $failed" -table "sc_task" -asign_grp $Assignment_Group}
        catch{$log+= "Unable to update ticket `n"}
    }
    catch{$log+= "Unable to update ticket `n"}
    End-log -logcontent $log -logpath "$path\Logs"
    Exit
}
#No evidence

Post Execution:

if(Process.Ping_check.scriptOutput.indexOf("Ticket Resolved Successfully")>=0)
{
  Process.ReturnCode=1
  Process.ReturnMessage="Ticket Resolved Successfully. "
}
else if(Process.Ping_check.scriptOutput.indexOf("Assignment Group updated successfully")>=0)
{
  Process.ReturnCode=2
  Process.ReturnMessage="Assignment Group updated successfully. "
}
else
{
Process.ReturnCode=-1
Process.returnMessage = "Failed to Reset Root Password"
}


5.Fatal Ticket Update

Pre Execution:

Process.putURL="https://"+Process.SNOW_Env+".service-now.com/api/now/table/sc_task/"+Process.Sys_Id+""
Process.FatalErrorPayLoad ="<request><entry><u_automation_result>Unsuccessful</u_automation_result><state>1</state><work_notes>"+Process.returnMessage+"Hence Routing the ticket.</work_notes></entry></request>"